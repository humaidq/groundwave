{{ template "head" . }}

{{ if .Breadcrumbs }}
<nav class="breadcrumb" aria-label="Breadcrumb">
  {{ range $i, $b := .Breadcrumbs }}
    {{ if $i }}<span class="breadcrumb-separator">&gt;</span>{{ end }}
    {{ if $b.IsCurrent }}
      <span class="breadcrumb-current">{{ $b.Name }}</span>
    {{ else }}
      <a href="{{ $b.URL }}" class="breadcrumb-item">{{ $b.Name }}</a>
    {{ end }}
  {{ end }}
</nav>
{{ end }}

<div class="page-header">
  <h2>Contacts</h2>
  <div class="page-header-actions">
    <a href="/overdue" class="btn">Overdue{{ if .OverdueCount }} ({{ .OverdueCount }}){{ end }}</a>
    <a href="/service-contacts" class="btn">Service Contacts</a>
    <a href="/contact/new" class="btn">+ Add Contact</a>
  </div>
</div>

{{ if .Error }}
<div class="alert alert-red">
  <h5 class="alert-title">Error</h5>
  <p>{{.Error}}</p>
</div>
{{end}}

<div class="tag-filter-section">
  <form method="POST" action="/private-mode/toggle" class="inline-form">
    <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
    <button type="submit" class="btn{{ if .PrivateMode }} btn-active{{ end }}">
      {{ if .PrivateMode }}Exit Private{{ else }}Private Mode{{ end }}
    </button>
  </form>
  <form method="GET" action="/contacts" class="tag-filter-form">
    {{ if .AllTags }}
    <div class="tag-dropdown-container">
      <button type="button" class="btn tag-dropdown-toggle" id="tagDropdownToggle">
        <span class="dropdown-label">Filter by Tags</span>
        {{ if .SelectedTags }}
        <span class="tag-count-badge">{{ len .SelectedTags }}</span>
        {{ end }}
        <span class="dropdown-arrow">▼</span>
      </button>

      <div class="tag-dropdown-menu" id="tagDropdownMenu">
        <div class="tag-dropdown-header">
          <span class="dropdown-title">Filter by tags</span>
        </div>
        <div class="tag-dropdown-list">
          {{ range .AllTags }}
          <label class="tag-checkbox-item">
            <input type="checkbox" name="tag" value="{{ .ID }}"
              {{- range $.SelectedTags }}{{- if eq . $.ID }} checked{{- end }}{{- end }}>
            <span class="tag-checkbox-label">{{ .Name }}</span>
            <span class="tag-checkbox-count">{{ .UsageCount }}</span>
          </label>
          {{ end }}
        </div>
        <div class="tag-dropdown-footer">
          <button type="submit" class="btn">Apply</button>
          <a href="/contacts" class="btn">Clear</a>
        </div>
      </div>
    </div>
    {{ end }}

    <div class="tag-dropdown-container">
      <button type="button" class="btn tag-dropdown-toggle" id="filterDropdownToggle">
        <span class="dropdown-label">Data Filters</span>
        {{ if .ActiveFilters }}
        <span class="tag-count-badge">{{ len .ActiveFilters }}</span>
        {{ end }}
        <span class="dropdown-arrow">▼</span>
      </button>

      <div class="tag-dropdown-menu" id="filterDropdownMenu">
        <div class="tag-dropdown-header">
          <span class="dropdown-title">Filter by data</span>
        </div>
        <div class="tag-dropdown-list">
          <label class="tag-checkbox-item">
            <input type="checkbox" name="filter" value="no_phone"
              {{ if contains .ActiveFilters "no_phone" }}checked{{ end }}>
            <span class="tag-checkbox-label">No phone number</span>
          </label>
          <label class="tag-checkbox-item">
            <input type="checkbox" name="filter" value="no_email"
              {{ if contains .ActiveFilters "no_email" }}checked{{ end }}>
            <span class="tag-checkbox-label">No email address</span>
          </label>
          <label class="tag-checkbox-item">
            <input type="checkbox" name="filter" value="no_carddav"
              {{ if contains .ActiveFilters "no_carddav" }}checked{{ end }}>
            <span class="tag-checkbox-label">Not linked to CardDAV</span>
          </label>
          <label class="tag-checkbox-item">
            <input type="checkbox" name="filter" value="no_linkedin"
              {{ if contains .ActiveFilters "no_linkedin" }}checked{{ end }}>
            <span class="tag-checkbox-label">No LinkedIn</span>
          </label>
        </div>
        <div class="tag-dropdown-footer">
          <button type="submit" class="btn">Apply</button>
          <a href="/contacts" class="btn">Clear</a>
        </div>
      </div>
    </div>

    {{ if .AllTags }}
    <a href="/tags" class="btn ml-half">Manage Tags</a>
    {{ end }}
  </form>
</div>

<script>
(function() {
  // Tag dropdown toggle
  const tagToggle = document.getElementById('tagDropdownToggle');
  const tagMenu = document.getElementById('tagDropdownMenu');

  if (tagToggle && tagMenu) {
    tagToggle.addEventListener('click', function(e) {
      e.preventDefault();
      tagMenu.classList.toggle('show');
      // Close filter menu when opening tag menu
      const filterMenu = document.getElementById('filterDropdownMenu');
      if (filterMenu) filterMenu.classList.remove('show');
    });
  }

  // Filter dropdown toggle
  const filterToggle = document.getElementById('filterDropdownToggle');
  const filterMenu = document.getElementById('filterDropdownMenu');

  if (filterToggle && filterMenu) {
    filterToggle.addEventListener('click', function(e) {
      e.preventDefault();
      filterMenu.classList.toggle('show');
      // Close tag menu when opening filter menu
      if (tagMenu) tagMenu.classList.remove('show');
    });
  }

  // Close dropdowns when clicking outside
  document.addEventListener('click', function(e) {
    if (tagToggle && tagMenu && !tagToggle.contains(e.target) && !tagMenu.contains(e.target)) {
      tagMenu.classList.remove('show');
    }
    if (filterToggle && filterMenu && !filterToggle.contains(e.target) && !filterMenu.contains(e.target)) {
      filterMenu.classList.remove('show');
    }
  });
})();
</script>

<input type="text" id="contactSearch" placeholder="Search contacts..." class="search-input">

{{ if .Contacts }}
<div id="contactList">
  {{ if .PrivateMode }}
  {{/* Private mode: flat alphabetical list, no tiers or tags */}}
  <div class="list-card-list">
  {{ range .Contacts }}
    <div class="list-card">
      <a href="/contact/{{ .ID }}" class="list-card-link">
        <div class="list-card-title">{{ .NameDisplay }}</div>
        {{ if .Organization }}
        <div class="list-card-meta">
          <span class="list-card-org muted-text">{{ .Organization }}</span>
        </div>
        {{ end }}
      </a>
    </div>
  {{ end }}
  </div>
  {{ else }}
  {{/* Normal mode: grouped by tier with tags */}}
  {{ $prevTier := "" }}
  {{ range .Contacts }}
    {{ if ne .Tier $prevTier }}
      {{ if ne $prevTier "" }}</div>{{ end }}
      <h3 class="section-heading">Tier {{ .Tier }}</h3>
      <div class="list-card-list">
      {{ $prevTier = .Tier }}
    {{ end }}
    <div class="list-card">
      <a href="/contact/{{ .ID }}" class="list-card-link">
        <div class="list-card-title">{{ .NameDisplay }}</div>
        {{ if or .Organization .Tags }}
        <div class="list-card-meta">
          {{ if .Organization }}
          <span class="list-card-org muted-text">{{ .Organization }}</span>
          {{ end }}
          {{ if .Tags }}
          <div class="tag-badges">
            {{ range .Tags }}
            <a href="/contacts?tag={{ .ID }}" class="tag-badge"
               onclick="event.stopPropagation(); event.preventDefault(); window.location.href='/contacts?tag={{ .ID }}';">
              {{ .Name }}
            </a>
            {{ end }}
          </div>
          {{ end }}
        </div>
        {{ end }}
      </a>
    </div>
  {{ end }}
  </div>
  {{ end }}
</div>
{{ else }}
<p class="muted-text">No contacts found. <a href="/contact/new">Add your first contact</a>.</p>
{{ end }}

<script>
(function() {
  const searchInput = document.getElementById('contactSearch');
  const contactList = document.getElementById('contactList');

  if (searchInput && contactList) {
    const entries = contactList.getElementsByClassName('list-card');

    searchInput.addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase();

      Array.from(entries).forEach(function(entry) {
        const text = entry.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
          entry.style.display = '';
        } else {
          entry.style.display = 'none';
        }
      });
    });
  }
})();
</script>

{{ template "foot" . }}
