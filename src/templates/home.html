{{ template "head" . }}

{{ if .Breadcrumbs }}
<nav class="breadcrumb" aria-label="Breadcrumb">
  {{ range $i, $b := .Breadcrumbs }}
    {{ if $i }}<span class="breadcrumb-separator">&gt;</span>{{ end }}
    {{ if $b.IsCurrent }}
      <span class="breadcrumb-current">{{ $b.Name }}</span>
    {{ else }}
      <a href="{{ $b.URL }}" class="breadcrumb-item">{{ $b.Name }}</a>
    {{ end }}
  {{ end }}
</nav>
{{ end }}

<div class="page-header">
  <h2>Contacts</h2>
  <div class="page-header-actions contacts-header-actions">
    {{ if not .SensitiveAccess }}
    <a href="/break-glass?next=/contacts" class="btn">Unlock Sensitive View</a>
    {{ end }}
    <a href="/tags" class="btn">Manage Tags</a>
    <a href="/overdue" class="btn">Overdue{{ if .OverdueCount }} ({{ .OverdueCount }}){{ end }}</a>
    <a href="/service-contacts" class="btn">Service Contacts</a>
    <a href="/bulk-contact-log" class="btn">Bulk Contact Log</a>
    <a href="/contact/new" class="btn">+ Add Contact</a>
  </div>
</div>

{{ if .Error }}
<div class="alert alert-red">
  <h5 class="alert-title">Error</h5>
  <p>{{.Error}}</p>
</div>
{{end}}

<div class="tag-filter-section">
  <form method="GET" action="/contacts" class="tag-filter-form">
    <input type="text" name="q" placeholder="Search" value="{{ .SearchQuery }}" class="form-item">
  </form>

  <details class="search-syntax-help muted-text">
    <summary class="search-syntax-toggle">
      <i class="fa-solid fa-circle-question" aria-hidden="true"></i>
      <span>Search syntax</span>
    </summary>
    <p class="search-syntax-examples">
      <span>Try:</span>
      <code>tier:c tag:university ali</code>,
      <code>callsign:a6*</code>,
      <code>has:carddav</code>,
      <code>-has:email</code>
    </p>
  </details>
</div>

{{ if .Contacts }}
<div id="contactList">
  {{ if not .SensitiveAccess }}
  {{/* Locked view: flat alphabetical list, no tiers or tags */}}
  <div class="list-card-list">
  {{ range .Contacts }}
    <div class="list-card">
      <a href="/contact/{{ .ID }}" class="list-card-link list-card-entry-link">
        <div class="list-card-entry">
          <span class="list-card-leading">
            <span class="list-card-icon" aria-hidden="true"><i class="fa-solid fa-user"></i></span>
          </span>
          <div class="list-card-entry-body">
            <div class="list-card-title">{{ .NameDisplay }}</div>
            {{ if .Organization }}
            <div class="list-card-meta">
              <span class="list-card-org muted-text">{{ .Organization }}</span>
            </div>
            {{ end }}
          </div>
        </div>
      </a>
    </div>
  {{ end }}
  </div>
  {{ else }}
  {{/* Sensitive view: grouped by tier with tags */}}
  {{ $prevTier := "" }}
  {{ range .Contacts }}
    {{ if ne .Tier $prevTier }}
      {{ if ne $prevTier "" }}</div>{{ end }}
      <h3 class="section-heading">Tier {{ .Tier }}</h3>
      <div class="list-card-list">
      {{ $prevTier = .Tier }}
    {{ end }}
    <div class="list-card">
      <a href="/contact/{{ .ID }}" class="list-card-link list-card-entry-link">
        <div class="list-card-entry">
          {{ $photo := safeImageURL .PhotoURL }}
          <span class="list-card-leading">
            {{ if $photo }}
            <img src="{{ $photo }}" alt="Photo of {{ .NameDisplay }}" class="contact-avatar contact-avatar-small" loading="lazy">
            {{ else }}
            <span class="list-card-icon" aria-hidden="true"><i class="fa-solid fa-user"></i></span>
            {{ end }}
          </span>
          <div class="list-card-entry-body">
            <div class="list-card-title">{{ .NameDisplay }}</div>
            {{ if or .Organization .Tags }}
            <div class="list-card-meta">
              {{ if .Organization }}
              <span class="list-card-org muted-text">{{ .Organization }}</span>
              {{ end }}
              {{ if .Tags }}
              <div class="tag-badges">
                {{ range .Tags }}
                <a href="/contacts?q=tag:{{ .Name | urlquery }}" class="tag-badge"
                   onclick="event.stopPropagation(); event.preventDefault(); window.location.href='/contacts?q=tag:{{ .Name | urlquery }}';">
                  {{ .Name }}
                </a>
                {{ end }}
              </div>
              {{ end }}
            </div>
            {{ end }}
          </div>
        </div>
      </a>
    </div>
  {{ end }}
  </div>
  {{ end }}
</div>
{{ else }}
<p class="muted-text">No contacts found. <a href="/contact/new">Add your first contact</a>.</p>
{{ end }}

{{ template "foot" . }}
