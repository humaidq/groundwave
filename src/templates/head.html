<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#1a1a1a" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="csrf-token" content="{{ .csrf_token }}" />
    <link rel="stylesheet" href="/normalize-8.0.1.min.css" />
    <link rel="stylesheet" href="/main.css" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" type="image/svg+xml" href="/icon.svg" />
    <link rel="apple-touch-icon" href="/icon-128.png" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>Groundwave</title>
    {{ if .IsZettelkasten }}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/katex.min.css" integrity="sha384-Pu5+C18nP5dwykLJOhd2U4Xen7rjScHN/qusop27hdd2drI+lL5KvX7YntvT8yew" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/katex.min.js" integrity="sha384-2B8pfmZZ6JlVoScJm/5hQfNS2TI/6hPqDZInzzPc8oHpN5SgeNOf4LzREO6p5YtZ" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/contrib/auto-render.min.js" integrity="sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh" crossorigin="anonymous"
        onload="renderMathInElement(document.body);"></script>
    {{ end }}
  </head>
  <body>
    <script>
      (function() {
        function setOffline(offline) {
          var bar = document.getElementById('offline-bar');
          if (bar) bar.classList.toggle('show', offline);
        }
        function startRestrictedCountdown() {
          var bar = document.getElementById('restricted-bar');
          if (!bar) return;
          var expiresAt = parseInt(bar.getAttribute('data-expires-at'), 10);
          if (!expiresAt) return;
          var countdown = bar.querySelector('.restricted-bar-countdown');
          if (!countdown) return;

          function pad(value) {
            return value < 10 ? '0' + value : String(value);
          }
          function formatRemaining(totalSeconds) {
            var hours = Math.floor(totalSeconds / 3600);
            var minutes = Math.floor((totalSeconds % 3600) / 60);
            var seconds = totalSeconds % 60;
            if (hours > 0) {
              return hours + ':' + pad(minutes) + ':' + pad(seconds);
            }
            return pad(minutes) + ':' + pad(seconds);
          }
          function updateCountdown() {
            var now = Math.floor(Date.now() / 1000);
            var remaining = expiresAt - now;
            if (remaining <= 0) {
              countdown.textContent = ' - Lock expired';
              return;
            }
            countdown.textContent = ' - Locks in ' + formatRemaining(remaining);
          }

          updateCountdown();
          setInterval(updateCountdown, 1000);
        }
        function checkOnline() {
          fetch('/connectivity', { cache: 'no-store' })
            .then(function(r) { setOffline(!r.ok); })
            .catch(function() { setOffline(true); });
        }
        document.addEventListener('DOMContentLoaded', function() {
          checkOnline();
          startRestrictedCountdown();
        });
        setInterval(checkOnline, 5000);
        window.addEventListener('online', checkOnline);
        window.addEventListener('offline', function() { setOffline(true); });
      })();
    </script>
    {{ if or (not .HideNav) .HeaderOnly }}
    <header class="groundwave-header">
      {{ if .SensitiveAccess }}
      <form id="restricted-bar" class="restricted-bar" method="POST" action="/sensitive-access/lock" data-expires-at="{{ .SensitiveAccessExpiresAt }}">
        <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
        <button type="submit" class="restricted-bar-btn">
          Restricted view is unlocked, you can view sensitive information. Click here to re-lock.
          <span class="restricted-bar-countdown" aria-live="off"></span>
        </button>
      </form>
      {{ end }}
      <div id="offline-bar" class="offline-bar">You are offline</div>
      <div class="header-container">
        <a href="/" class="header-logo">Groundwave</a>
        {{ if and (not .HideNav) (not .HeaderOnly) }}
        <button class="nav-hamburger" aria-label="Toggle navigation menu" onclick="this.classList.toggle('active');document.querySelector('.nav-menu').classList.toggle('active')">
          <span></span>
          <span></span>
          <span></span>
        </button>
        {{ end }}
      </div>
      {{ if and (not .HideNav) (not .HeaderOnly) }}
      <nav class="navbar">
        <div class="nav-menu">
          <a href="/"{{ if .IsWelcome }} class="nav-active"{{ end }}>Home</a>
          {{ if .IsAdmin }}
          <a href="/todo"{{ if .IsTodo }} class="nav-active"{{ end }}>Todo</a>
          <a href="/files"{{ if .IsFiles }} class="nav-active"{{ end }}>Files</a>
          <a href="/timeline"{{ if .IsTimeline }} class="nav-active"{{ end }}>Timeline</a>
          <a href="/ledger"{{ if .IsLedger }} class="nav-active"{{ end }}>Ledger</a>
          <a href="/contacts"{{ if .IsContacts }} class="nav-active"{{ end }}>Contacts</a>
          <a href="/qsl"{{ if .IsQSL }} class="nav-active"{{ end }}>QSL</a>
          <a href="/zk"{{ if .IsZettelkasten }} class="nav-active"{{ end }}>Zettelkasten</a>
          {{ end }}
          <a href="/inventory"{{ if .IsInventory }} class="nav-active"{{ end }}>Inventory</a>
          {{ if not .IsAdmin }}
          <a href="/files"{{ if .IsFiles }} class="nav-active"{{ end }}>Files</a>
          {{ end }}
          <a href="/health"{{ if .IsHealth }} class="nav-active"{{ end }}>Health</a>
        </div>
      </nav>
      {{ end }}
    </header>
    {{ end }}
    <main{{ if and .HideNav (not .HeaderOnly) }} class="main-no-header"{{ end }}>
      {{ if .Flash }}
        {{ $flash := .Flash }}
        {{ if eq $flash.Type "error" }}
          <div class="alert alert-red">
            <h5 class="alert-title">Error</h5>
            <p>{{ $flash.Message }}</p>
          </div>
        {{ else if eq $flash.Type "success" }}
          <div class="alert alert-green">
            <h5 class="alert-title">Success</h5>
            <p>{{ $flash.Message }}</p>
          </div>
        {{ else if eq $flash.Type "warning" }}
          <div class="alert alert-yellow">
            <h5 class="alert-title">Warning</h5>
            <p>{{ $flash.Message }}</p>
          </div>
        {{ else if eq $flash.Type "info" }}
          <div class="alert alert-grey">
            <h5 class="alert-title">Info</h5>
            <p>{{ $flash.Message }}</p>
          </div>
        {{ end }}
      {{ end }}
