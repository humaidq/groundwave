{{ template "head" . }}

{{ if .Breadcrumbs }}
<nav class="breadcrumb" aria-label="Breadcrumb">
  {{ range $i, $b := .Breadcrumbs }}
    {{ if $i }}<span class="breadcrumb-separator">&gt;</span>{{ end }}
    {{ if $b.IsCurrent }}
      <span class="breadcrumb-current">{{ $b.Name }}</span>
    {{ else }}
      <a href="{{ $b.URL }}" class="breadcrumb-item">{{ $b.Name }}</a>
    {{ end }}
  {{ end }}
</nav>
{{ end }}

  <div class="page-header">
    <h2>Zettelkasten Comments Inbox</h2>
    <div class="page-header-actions">
      {{ template "zk_header_actions" . }}
    </div>
  </div>

  {{ if .Error }}
  <div class="alert alert-red">
    {{ .Error }}
  </div>
  {{ end }}

  {{ if eq .CommentCount 0 }}
  <div class="empty-state">
    <p>No comments yet.</p>
    <a href="/zk" class="btn">Browse Zettelkasten</a>
  </div>
  {{ else }}
  <div class="inbox-stats">
    <p><strong>{{ .CommentCount }}</strong> comment{{ if ne .CommentCount 1 }}s{{ end }} across <strong>{{ len .Groups }}</strong> note{{ if ne (len .Groups) 1 }}s{{ end }}</p>
  </div>

  {{ range .Groups }}
  {{ $zettelID := .ZettelID }}
  {{ $zettelTitle := .ZettelTitle }}
  {{ $zettelFilename := .ZettelFilename }}
  {{ $orphanedNote := .OrphanedNote }}
  <div class="inbox-group">
    <div class="inbox-group-header">
      {{ if $orphanedNote }}
      <h3 class="orphaned-note-title">
        <span class="orphaned-badge">⚠ Orphaned</span>
        {{ $zettelTitle }}
      </h3>
      <p class="orphaned-note-message">
        Note file not found (ID: <code>{{ $zettelID }}</code>).
        The file may have been moved or deleted from WebDAV.
      </p>
      {{ else }}
      <h3>
        <a href="/zk/{{ $zettelID }}" class="zk-link">{{ $zettelTitle }}</a>
      </h3>
      <p class="inbox-group-meta">
        <code>{{ $zettelFilename }}</code>
      </p>
      {{ end }}
    </div>

    <div class="log-list">
      {{ range .Comments }}
      <div class="log-entry">
        <div class="log-header">
          <span class="log-type log-type-note">comment</span>
          <span class="log-date">{{ .CreatedAt.Format "Jan 2, 2006 3:04 PM" }}</span>
          <details class="inline-edit-details">
            <summary class="btn-edit" title="Edit">✎</summary>
            <form method="POST" action="/zk/{{ $zettelID }}/comment/{{ .ID }}/edit" class="inline-edit-form">
              <input type="hidden" name="_csrf" value="{{ $.csrf_token }}" />
              <input type="hidden" name="redirect_to" value="inbox" />
              <div class="add-item-field">
                <textarea name="content" class="form-item" rows="4" required>{{ .Content }}</textarea>
              </div>
              <button type="submit" class="btn">Save</button>
            </form>
          </details>
          <form method="POST" action="/zk/{{ $zettelID }}/comment/{{ .ID }}/delete" class="log-delete-form" onsubmit="return confirm('Delete this comment?');">
            <input type="hidden" name="_csrf" value="{{ $.csrf_token }}" />
            <button type="submit" class="btn-delete" title="Delete">×</button>
          </form>
        </div>
        <div class="log-content">{{ .Content }}</div>
      </div>
      {{ end }}
    </div>
  </div>
  {{ end }}
  {{ end }}
</main>

{{ template "foot" . }}
