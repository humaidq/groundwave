{{ template "head" . }}

{{ if .Breadcrumbs }}
<nav class="breadcrumb" aria-label="Breadcrumb">
  {{ range $i, $b := .Breadcrumbs }}
    {{ if $i }}<span class="breadcrumb-separator">&gt;</span>{{ end }}
    {{ if $b.IsCurrent }}
      <span class="breadcrumb-current">{{ $b.Name }}</span>
    {{ else }}
      <a href="{{ $b.URL }}" class="breadcrumb-item">{{ $b.Name }}</a>
    {{ end }}
  {{ end }}
</nav>
{{ end }}

<div class="page-header">
  <div class="page-header-stack">
    <h2>Files</h2>
    <div class="page-header-meta">
      <span class="muted-text">{{ .CurrentPathDisplay }}</span>
      {{ if .EntriesCount }}
      <span class="muted-text">{{ .EntriesCount }} item{{ if ne .EntriesCount 1 }}s{{ end }}</span>
      {{ end }}
      {{ if .IsRestricted }}
      <span class="status-badge status-restricted">Restricted</span>
      {{ end }}
      {{ if .IsAdminOnly }}
      <span class="status-badge status-admin">Admin</span>
      {{ end }}
    </div>
  </div>
  <div class="page-header-actions">
    <form method="POST" action="/files/upload" enctype="multipart/form-data" class="inline-form">
      <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
      <input type="hidden" name="path" value="{{ .CurrentPath }}" />
      <input type="file" name="upload_file" id="files_upload" class="hidden-file-input" onchange="this.form.submit()">
      <button type="button" class="btn" onclick="document.getElementById('files_upload').click()">Upload</button>
    </form>
    {{ if .HasParent }}
    <a href="/files{{ if .ParentPath }}?path={{ .ParentPath | urlquery }}{{ end }}" class="btn">Up</a>
    {{ end }}
    {{ if .ParentPath }}
    <a href="/files" class="btn">Root</a>
    {{ end }}
  </div>
</div>

{{ if .IsAdmin }}
<details class="add-item-details">
  <summary class="add-item-summary">+ New folder</summary>
  <form method="POST" action="/files/mkdir" class="add-item-form">
    <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
    <input type="hidden" name="path" value="{{ .CurrentPath }}" />
    <div class="add-item-field">
      <input type="text" name="dir_name" class="form-item" placeholder="Folder name" required>
    </div>
    <button type="submit" class="btn btn-block">Create folder</button>
  </form>
</details>

<details class="add-item-details">
  <summary class="add-item-summary">+ New plaintext file</summary>
  <form method="POST" action="/files/new" class="add-item-form">
    <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
    <input type="hidden" name="path" value="{{ .CurrentPath }}" />
    <div class="add-item-field">
      <input type="text" name="file_name" class="form-item" placeholder="File name (e.g. notes.txt)" required>
    </div>
    <div class="add-item-field">
      <textarea name="content" class="form-item" rows="5" placeholder="Optional initial content"></textarea>
    </div>
    <button type="submit" class="btn btn-block">Create file</button>
  </form>
</details>
{{ end }}

{{ if .Error }}
<div class="alert alert-red">
  <h5 class="alert-title">Error</h5>
  <p>{{ .Error }}</p>
</div>
{{ end }}

{{ if .Entries }}
<div class="list-card-list">
  {{ range .Entries }}
  <div class="list-card">
    {{ if .IsDir }}
    <a href="/files?path={{ .Path | urlquery }}" class="list-card-link">
      <div class="list-card-title"><i class="fa-solid fa-folder" aria-hidden="true"></i> {{ .Name }}</div>
      <div class="list-card-meta">
        <span class="muted-text">Folder</span>
      </div>
    </a>
    {{ else }}
    <a href="/files/view?path={{ .Path | urlquery }}" class="list-card-link">
      <div class="list-card-title"><i class="fa-solid fa-file" aria-hidden="true"></i> {{ .Name }}</div>
      <div class="list-card-meta">
        <span class="muted-text">{{ formatFileSize .Size }}{{ if not .ModTime.IsZero }} â€¢ {{ .ModTime.Format "Jan 2, 2006" }}{{ end }}</span>
      </div>
    </a>
    {{ end }}
  </div>
  {{ end }}
</div>
{{ else }}
<p class="empty-state">No files here.</p>
{{ end }}

{{ if and .IsAdmin .CurrentPath }}
<div class="detail-section files-folder-manage">
  <h3>Manage Folder</h3>
  <details class="add-item-details">
    <summary class="add-item-summary">Rename folder</summary>
    <form method="POST" action="/files/rename" class="add-item-form">
      <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
      <input type="hidden" name="path" value="{{ .CurrentPath }}" />
      <div class="add-item-field">
        <input type="text" name="new_name" class="form-item" value="{{ .FileName }}" placeholder="New folder name" required>
      </div>
      <button type="submit" class="btn btn-block">Rename</button>
    </form>
  </details>
  <details class="add-item-details">
    <summary class="add-item-summary">Move folder</summary>
    <form method="POST" action="/files/move" class="add-item-form">
      <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
      <input type="hidden" name="path" value="{{ .CurrentPath }}" />
      <div class="add-item-field">
        <input type="text" name="target_dir" class="form-item" placeholder="Destination folder (e.g. docs/archive)">
      </div>
      <button type="submit" class="btn btn-block">Move</button>
    </form>
  </details>
  <form method="POST" action="/files/rmdir" class="files-manage-delete" onsubmit="return confirm('Delete this folder? It must be empty.');">
    <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
    <input type="hidden" name="path" value="{{ .CurrentPath }}" />
    <button type="submit" class="btn btn-danger btn-block">Delete folder</button>
  </form>
</div>
{{ end }}

{{ template "foot" . }}
