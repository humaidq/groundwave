{{ template "head" . }}

{{ if .Breadcrumbs }}
<nav class="breadcrumb" aria-label="Breadcrumb">
  {{ range $i, $b := .Breadcrumbs }}
    {{ if $i }}<span class="breadcrumb-separator">&gt;</span>{{ end }}
    {{ if $b.IsCurrent }}
      <span class="breadcrumb-current">{{ $b.Name }}</span>
    {{ else }}
      <a href="{{ $b.URL }}" class="breadcrumb-item">{{ $b.Name }}</a>
    {{ end }}
  {{ end }}
</nav>
{{ end }}

{{ if .Error }}
<div class="alert alert-red">
  {{ .Error }}
</div>
{{ end }}

<div class="page-header">
  <h2>{{ .Contact.NameDisplay }}</h2>
  <div class="page-header-actions">
    <a href="/contact/{{ .Contact.ID }}/edit" class="btn">Edit Contact</a>
    <form method="POST" action="/contact/{{ .Contact.ID }}/delete" class="inline-form" onsubmit="return confirm('Are you sure you want to delete this contact? This action cannot be undone.');">
      <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
      <button type="submit" class="btn btn-danger">Delete Contact</button>
    </form>
  </div>
</div>

<div class="contact-detail">
  <div class="contact-section">
    <div class="contact-meta">
      {{ if not .Contact.IsService }}
      {{ if not .PrivateMode }}
      <span class="contact-tier tier-{{ .TierLower }}">{{ .Contact.Tier }}</span>
      <a href="/contact/{{ .Contact.ID }}/chats" class="btn ml-half">Chats</a>
      {{ end }}
      {{ with .Contact.CallSign }}
      <span class="contact-callsign">{{ . }}</span>
      {{ end }}
      {{ end }}
    </div>

    {{ with .Contact.Organization }}
    <div class="detail-item">
      <span class="detail-label">Organization:</span>
      <span class="detail-value">{{ . }}</span>
    </div>
    {{ end }}

    {{ with .Contact.Title }}
    <div class="detail-item">
      <span class="detail-label">Title:</span>
      <span class="detail-value">{{ . }}</span>
    </div>
    {{ end }}

    {{ if not .Contact.IsService }}
    {{ with .Contact.LastAutoContact }}
    <div class="detail-item">
      <span class="detail-label">Last WhatsApp:</span>
      <span class="detail-value">{{ .Format "Jan 2, 2006 3:04 PM" }}</span>
    </div>
    {{ end }}
    {{ end }}
  </div>

  {{ if not .PrivateMode }}
  <div class="contact-section">
    <h3>Tags</h3>
    {{ if .Contact.Tags }}
    <div class="tag-pills">
      {{ range .Contact.Tags }}
      <div class="tag-pill">
        <a href="/contacts?tag={{ .ID }}" class="tag-pill-link">
          <span class="tag-pill-name">{{ .Name }}</span>
        </a>
        <form method="POST" action="/contact/{{ $.Contact.ID }}/tag/{{ .ID }}/delete" class="tag-pill-delete-form" onsubmit="return confirm('Remove this tag?');">
          <input type="hidden" name="_csrf" value="{{ $.csrf_token }}" />
          <button type="submit" class="tag-pill-delete-btn" title="Remove">×</button>
        </form>
      </div>
      {{ end }}
    </div>
    {{ end }}

    <details class="add-item-details">
      <summary class="add-item-summary">+ Add Tag</summary>
      <form method="POST" action="/contact/{{ .Contact.ID }}/tag" class="add-item-form">
        <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
        <div class="add-item-field">
          <div class="autocomplete-container">
            <input type="text" name="tag_name" id="tag-autocomplete" placeholder="Tag name (e.g., event:something-2025, place:uni-x)" required class="form-item" pattern="[a-z0-9._:-]+" title="Lowercase letters, numbers, and ._:- characters only" autocomplete="off">
            <div class="autocomplete-dropdown" id="tag-dropdown"></div>
          </div>
          <p class="help-text">Use namespace:value format for categorization (e.g., event:something-2025)</p>
        </div>
        <button type="submit" class="btn">Add Tag</button>
      </form>
    </details>
  </div>
  {{ end }}

  {{ if and (not .Contact.IsService) (not .PrivateMode) }}
  <div class="contact-section">
    <h3>Activity Feed</h3>

    <details class="add-item-details">
      <summary class="add-item-summary">+ Add Note</summary>
      <form method="POST" action="/contact/{{ .Contact.ID }}/note" class="add-item-form">
        <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
        <div class="add-item-field">
          <textarea name="content" id="note_content" class="form-item" rows="3" placeholder="Add a timestamped note..." required></textarea>
        </div>
        <div class="add-item-field">
          <input type="datetime-local" name="noted_at" id="noted_at" class="form-item" placeholder="Date/Time (optional)">
          <button type="submit" class="btn">Post Note</button>
        </div>
      </form>
    </details>

    <details class="add-item-details">
      <summary class="add-item-summary">+ Add Contact Log</summary>
      <form method="POST" action="/contact/{{ .Contact.ID }}/log" class="add-item-form">
        <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
        <div class="add-item-field">
          <select name="log_type" id="log_type" class="form-item">
            <option value="general">General</option>
            <option value="email_sent">Email Sent</option>
            <option value="email_received">Email Received</option>
            <option value="call">Phone/Video Call</option>
            <option value="meeting">Meeting</option>
            <option value="message">Text/Chat Message</option>
            <option value="gift_sent">Gift Sent</option>
            <option value="gift_received">Gift Received</option>
            <option value="intro">Introduction Made</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="add-item-field">
          <input type="date" name="logged_at" id="logged_at" class="form-item" placeholder="Date (optional)">
        </div>
        <div class="add-item-field">
          <textarea name="content" id="content" class="form-item" rows="3" placeholder="Details (optional)"></textarea>
        </div>
        <button type="submit" class="btn">Add Log Entry</button>
      </form>
    </details>

    {{ if or .Contact.Logs .Contact.Notes (and .CardDAVContact .CardDAVContact.Notes) }}
    <div class="log-list">
      {{/* Create a unified feed by combining logs and notes */}}
      {{ $contact := .Contact }}
      {{ range .Contact.Logs }}
      <div class="log-entry">
        <div class="log-header">
          <span class="log-type log-type-{{ .LogType }}">{{ .LogType }}</span>
          <span class="log-date">{{ .LoggedAt.Format "Jan 2, 2006" }}</span>
          <form method="POST" action="/contact/{{ $contact.ID }}/log/{{ .ID }}/delete" class="log-delete-form" onsubmit="return confirm('Delete this log entry?');">
            <input type="hidden" name="_csrf" value="{{ $.csrf_token }}" />
            <button type="submit" class="btn-delete" title="Delete">×</button>
          </form>
        </div>
        {{ with .Content }}
        <div class="log-content">{{ . }}</div>
        {{ end }}
      </div>
      {{ end }}
      {{ range .Contact.Notes }}
      <div class="log-entry">
        <div class="log-header">
          <span class="log-type log-type-note">note</span>
          <span class="log-date">{{ .NotedAt.Format "Jan 2, 2006" }}</span>
          <form method="POST" action="/contact/{{ $contact.ID }}/note/{{ .ID }}/delete" class="log-delete-form" onsubmit="return confirm('Delete this note?');">
            <input type="hidden" name="_csrf" value="{{ $.csrf_token }}" />
            <button type="submit" class="btn-delete" title="Delete">×</button>
          </form>
        </div>
        <div class="log-content">{{ .Content }}</div>
      </div>
      {{ end }}
      {{ if $.CardDAVContact }}
      {{ if $.CardDAVContact.Notes }}
      <div class="log-entry">
        <div class="log-header">
          <span class="log-type log-type-note">note</span>
          <span class="log-date muted-text">CardDAV</span>
        </div>
        <div class="log-content">{{ $.CardDAVContact.Notes }}</div>
      </div>
      {{ end }}
      {{ end }}
    </div>
    {{ else }}
    <p class="muted-text">No activity recorded yet.</p>
    {{ end }}
  </div>
  {{ end }}

  <div class="contact-section">
    <h3>Email Addresses</h3>
    {{ if .Contact.Emails }}
    {{ range .Contact.Emails }}
    <div class="contact-item">
      <div class="contact-item-content">
        <a href="mailto:{{ .Email }}" class="contact-item-value">{{ .Email }}</a>
        <div class="contact-item-meta">
          {{ .EmailType }}{{ if .IsPrimary }} • Primary{{ end }}{{ if eq .Source "carddav" }} • CardDAV{{ end }}
        </div>
      </div>
      <details class="inline-edit-details">
        <summary class="btn-edit" title="Edit">✎</summary>
        <form method="POST" action="/contact/{{ $.Contact.ID }}/email/{{ .ID }}/edit" class="inline-edit-form">
          <input type="hidden" name="_csrf" value="{{ $.csrf_token }}" />
          <div class="add-item-field">
            <input type="email" name="email" value="{{ .Email }}" required class="form-item">
          </div>
          <div class="add-item-field">
            <select name="email_type" class="form-item">
              <option value="personal" {{ if eq .EmailType "personal" }}selected{{ end }}>Personal</option>
              <option value="work" {{ if eq .EmailType "work" }}selected{{ end }}>Work</option>
              <option value="other" {{ if eq .EmailType "other" }}selected{{ end }}>Other</option>
            </select>
          </div>
          <div class="add-item-field">
            <label class="checkbox-label">
              <input type="checkbox" name="is_primary" {{ if .IsPrimary }}checked{{ end }}> Primary
            </label>
          </div>
          <button type="submit" class="btn">Save</button>
        </form>
      </details>
      <form method="POST" action="/contact/{{ $.Contact.ID }}/email/{{ .ID }}/delete" class="item-delete-form" onsubmit="return confirm('Delete this email address?');">
        <input type="hidden" name="_csrf" value="{{ $.csrf_token }}" />
        <button type="submit" class="btn-delete" title="Delete">×</button>
      </form>
    </div>
    {{ end }}
    {{ end }}

    <details class="add-item-details">
      <summary class="add-item-summary">+ Add Email</summary>
      <form method="POST" action="/contact/{{ .Contact.ID }}/email" class="add-item-form">
        <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
        <div class="add-item-field">
          <input type="email" name="email" placeholder="Email address" required class="form-item">
        </div>
        <div class="add-item-field">
          <select name="email_type" class="form-item">
            <option value="personal">Personal</option>
            <option value="work">Work</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="add-item-field">
          <label class="checkbox-label">
            <input type="checkbox" name="is_primary"> Mark as primary
          </label>
        </div>
        <button type="submit" class="btn">Add Email</button>
      </form>
    </details>
  </div>

  <div class="contact-section">
    <h3>Phone Numbers</h3>
    {{ if .Contact.Phones }}
    {{ range .Contact.Phones }}
    <div class="contact-item">
      <div class="contact-item-content">
        <a href="tel:{{ .Phone }}" class="contact-item-value">{{ .Phone }}</a>
        <div class="contact-item-meta">
          {{ .PhoneType }}{{ if .IsPrimary }} • Primary{{ end }}{{ if eq .Source "carddav" }} • CardDAV{{ end }}
        </div>
      </div>
      <details class="inline-edit-details">
        <summary class="btn-edit" title="Edit">✎</summary>
        <form method="POST" action="/contact/{{ $.Contact.ID }}/phone/{{ .ID }}/edit" class="inline-edit-form">
          <input type="hidden" name="_csrf" value="{{ $.csrf_token }}" />
          <div class="add-item-field">
            <input type="tel" name="phone" value="{{ .Phone }}" required class="form-item">
          </div>
          <div class="add-item-field">
            <select name="phone_type" class="form-item">
              <option value="cell" {{ if eq .PhoneType "cell" }}selected{{ end }}>Cell</option>
              <option value="home" {{ if eq .PhoneType "home" }}selected{{ end }}>Home</option>
              <option value="work" {{ if eq .PhoneType "work" }}selected{{ end }}>Work</option>
              <option value="fax" {{ if eq .PhoneType "fax" }}selected{{ end }}>Fax</option>
              <option value="pager" {{ if eq .PhoneType "pager" }}selected{{ end }}>Pager</option>
              <option value="other" {{ if eq .PhoneType "other" }}selected{{ end }}>Other</option>
            </select>
          </div>
          <div class="add-item-field">
            <label class="checkbox-label">
              <input type="checkbox" name="is_primary" {{ if .IsPrimary }}checked{{ end }}> Primary
            </label>
          </div>
          <button type="submit" class="btn">Save</button>
        </form>
      </details>
      <form method="POST" action="/contact/{{ $.Contact.ID }}/phone/{{ .ID }}/delete" class="item-delete-form" onsubmit="return confirm('Delete this phone number?');">
        <input type="hidden" name="_csrf" value="{{ $.csrf_token }}" />
        <button type="submit" class="btn-delete" title="Delete">×</button>
      </form>
    </div>
    {{ end }}
    {{ end }}

    <details class="add-item-details">
      <summary class="add-item-summary">+ Add Phone</summary>
      <form method="POST" action="/contact/{{ .Contact.ID }}/phone" class="add-item-form">
        <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
        <div class="add-item-field">
          <input type="tel" name="phone" placeholder="Phone number" required class="form-item">
        </div>
        <div class="add-item-field">
          <select name="phone_type" class="form-item">
            <option value="cell">Cell</option>
            <option value="home">Home</option>
            <option value="work">Work</option>
            <option value="fax">Fax</option>
            <option value="pager">Pager</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="add-item-field">
          <label class="checkbox-label">
            <input type="checkbox" name="is_primary"> Mark as primary
          </label>
        </div>
        <button type="submit" class="btn">Add Phone</button>
      </form>
    </details>
  </div>

  {{ if .Contact.Addresses }}
  <div class="contact-section">
    <h3>Addresses</h3>
    {{ range .Contact.Addresses }}
    <div class="contact-item">
      <div class="contact-item-content">
        <div class="contact-item-value">
          {{ if .Street }}{{ .Street }}<br>{{ end }}
          {{ if .Locality }}{{ .Locality }}{{ end }}{{ if .Region }}, {{ .Region }}{{ end }} {{ if .PostalCode }}{{ .PostalCode }}{{ end }}
          {{ if .Country }}<br>{{ .Country }}{{ end }}
        </div>
        <div class="contact-item-meta">
          {{ .AddressType }}{{ if .IsPrimary }} • Primary{{ end }}
        </div>
      </div>
    </div>
    {{ end }}
  </div>
  {{ end }}

  <div class="contact-section">
    <h3>Links & Social Media</h3>
    {{ if .Contact.URLs }}
    {{ range .Contact.URLs }}
    <div class="contact-item">
      <div class="contact-item-content">
        <a href="{{ .URL }}" target="_blank" class="contact-item-value">
          {{ if .Label }}{{ .Label }}{{ else }}{{ .URL }}{{ end }}
        </a>
        <div class="contact-item-meta">
          {{ .URLType }}{{ if .Username }} • @{{ .Username }}{{ end }}
        </div>
      </div>
      <form method="POST" action="/contact/{{ $.Contact.ID }}/url/{{ .ID }}/delete" class="item-delete-form" onsubmit="return confirm('Delete this link?');">
        <input type="hidden" name="_csrf" value="{{ $.csrf_token }}" />
        <button type="submit" class="btn-delete" title="Delete">×</button>
      </form>
    </div>
    {{ end }}
    {{ end }}

    <details class="add-item-details">
      <summary class="add-item-summary">+ Add Link/Social</summary>
      <form method="POST" action="/contact/{{ .Contact.ID }}/url" class="add-item-form">
        <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
        <div class="add-item-field">
          <input type="url" id="contact-url-input" name="url" placeholder="URL" required class="form-item">
        </div>
        <div class="add-item-field">
          <select id="contact-url-type" name="url_type" class="form-item">
            <option value="website">Website</option>
            <option value="blog">Blog</option>
            <option value="twitter">Twitter</option>
            <option value="mastodon">Mastodon</option>
            <option value="bluesky">Bluesky</option>
            <option value="instagram">Instagram</option>
            <option value="linkedin">LinkedIn</option>
            <option value="orcid">ORCID</option>
            <option value="github">GitHub</option>
            <option value="gitlab">GitLab</option>
            <option value="codeberg">Codeberg</option>
            <option value="youtube">YouTube</option>
            <option value="signal">Signal</option>
            <option value="whatsapp">WhatsApp</option>
            <option value="matrix">Matrix</option>
            <option value="qrz">QRZ</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="add-item-field">
          <input type="text" name="label" placeholder="Label (optional)" class="form-item">
        </div>
        <div class="add-item-field">
          <input type="text" name="username" placeholder="Username (optional)" class="form-item">
        </div>
        <button type="submit" class="btn">Add Link</button>
      </form>
    </details>
  </div>

  {{ if .QSOs }}
  <div class="contact-section">
    <h3>QSO Log ({{ len .QSOs }} contacts)</h3>
    <table class="contacts-list">
      <thead>
        <tr>
          <th>Date</th>
          <th>Time (UTC)</th>
          <th>Band</th>
          <th>Mode</th>
          <th>RST</th>
          <th>Country</th>
        </tr>
      </thead>
      <tbody>
        {{ range .QSOs }}
        <tr class="clickable-row" onclick="window.location='/qsl/{{ .ID }}'">
          <td>
            {{ .QSODate.Format "2006-01-02" }}
          </td>
          <td>
            {{ .TimeOn.Format "15:04" }}
          </td>
          <td>
            {{ if .Band }}
            {{ .Band }}
            {{ else }}
            <span class="muted-text">—</span>
            {{ end }}
          </td>
          <td>
            {{ .Mode }}
          </td>
          <td>
            <div class="rst-info">
              {{ if .RSTSent }}
              <div>Sent: {{ .RSTSent }}</div>
              {{ end }}
              {{ if .RSTRcvd }}
              <div>Rcvd: {{ .RSTRcvd }}</div>
              {{ end }}
              {{ if not .RSTSent }}{{ if not .RSTRcvd }}
              <span class="muted-text">—</span>
              {{ end }}{{ end }}
            </div>
          </td>
          <td>
            {{ if .Country }}
            {{ .Country }}
            {{ else }}
            <span class="muted-text">—</span>
            {{ end }}
          </td>
        </tr>
        {{ end }}
      </tbody>
    </table>
  </div>
  {{ end }}

  <div class="contact-section">
    <a href="/contacts" class="btn">← Back to Contacts</a>
  </div>
</div>

<script>
// Initialize tag autocomplete and link type detection
document.addEventListener('DOMContentLoaded', function() {
  var tagNames = [{{ range $i, $t := .AllTags }}{{ if $i }}, {{ end }}"{{ $t.Name }}"{{ end }}];
  if (tagNames.length > 0) {
    initAutocomplete('#tag-autocomplete', tagNames);
  }

  var urlInput = document.getElementById('contact-url-input');
  var urlTypeSelect = document.getElementById('contact-url-type');
  if (!urlInput || !urlTypeSelect) {
    return;
  }

  var manualSelection = false;
  var manualUrlValue = '';

  urlTypeSelect.addEventListener('change', function() {
    manualSelection = true;
    manualUrlValue = urlInput.value.trim();
  });

  function parseUrl(value) {
    if (!value) return null;
    try {
      return new URL(value);
    } catch (err) {
      try {
        return new URL('https://' + value);
      } catch (err2) {
        return null;
      }
    }
  }

  function detectUrlType(value) {
    var parsed = parseUrl(value);
    if (!parsed) return '';
    var host = parsed.hostname.toLowerCase();

    var matchers = [
      { type: 'linkedin', patterns: ['linkedin.com'] },
      { type: 'twitter', patterns: ['twitter.com', 'x.com'] },
      { type: 'mastodon', patterns: ['mastodon'] },
      { type: 'bluesky', patterns: ['bsky.app', 'bsky.social', 'bluesky'] },
      { type: 'instagram', patterns: ['instagram.com'] },
      { type: 'orcid', patterns: ['orcid.org'] },
      { type: 'github', patterns: ['github.com'] },
      { type: 'gitlab', patterns: ['gitlab.com'] },
      { type: 'codeberg', patterns: ['codeberg.org'] },
      { type: 'youtube', patterns: ['youtube.com', 'youtu.be'] },
      { type: 'signal', patterns: ['signal.me', 'signal.org'] },
      { type: 'whatsapp', patterns: ['wa.me', 'whatsapp.com'] },
      { type: 'matrix', patterns: ['matrix.to', 'element.io'] },
      { type: 'qrz', patterns: ['qrz.com'] }
    ];

    for (var i = 0; i < matchers.length; i++) {
      var matcher = matchers[i];
      for (var j = 0; j < matcher.patterns.length; j++) {
        if (host.includes(matcher.patterns[j])) {
          return matcher.type;
        }
      }
    }

    return '';
  }

  urlInput.addEventListener('input', function() {
    var value = urlInput.value.trim();
    if (manualSelection && value === manualUrlValue) {
      return;
    }
    if (value !== manualUrlValue) {
      manualSelection = false;
      manualUrlValue = '';
    }

    var detectedType = detectUrlType(value);
    if (!detectedType) {
      return;
    }

    var option = urlTypeSelect.querySelector('option[value="' + detectedType + '"]');
    if (option) {
      urlTypeSelect.value = detectedType;
    }
  });
});
</script>

{{ template "foot" . }}
