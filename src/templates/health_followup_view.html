{{ template "head" . }}

{{ if .Breadcrumbs }}
<nav class="breadcrumb" aria-label="Breadcrumb">
  {{ range $i, $b := .Breadcrumbs }}
    {{ if $i }}<span class="breadcrumb-separator">&gt;</span>{{ end }}
    {{ if $b.IsCurrent }}
      <span class="breadcrumb-current">{{ $b.Name }}</span>
    {{ else }}
      <a href="{{ $b.URL }}" class="breadcrumb-item">{{ $b.Name }}</a>
    {{ end }}
  {{ end }}
</nav>
{{ end }}

{{ if .Error }}
<div class="alert alert-red">
  {{ .Error }}
</div>
{{ end }}

<div class="page-header">
  <h2>{{ .Followup.FollowupDate.Format "Jan 2, 2006" }} - {{ .Followup.HospitalName }}</h2>
  <div class="page-header-actions">
    {{ if .IsAdmin }}
    <a href="/health/{{ .Profile.ID }}/followup/{{ .Followup.ID }}/edit" class="btn">Edit</a>
    <form method="POST" action="/health/{{ .Profile.ID }}/followup/{{ .Followup.ID }}/delete" class="inline-form" onsubmit="return confirm('Delete this follow-up and all test results? This cannot be undone.');">
      <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
      <button type="submit" class="btn btn-danger">Delete</button>
    </form>
    {{ end }}
  </div>
</div>

<div class="detail-layout">
  <!-- Follow-up Details -->
  <div class="detail-section">
    <h3>Follow-up Information</h3>
    <div class="detail-item">
      <span class="detail-label">Patient:</span>
      <span class="detail-value"><a href="/health/{{ .Profile.ID }}">{{ .Profile.Name }}</a></span>
    </div>
    <div class="detail-item">
      <span class="detail-label">Date:</span>
      <span class="detail-value">{{ .Followup.FollowupDate.Format "January 2, 2006" }}</span>
    </div>
    <div class="detail-item">
      <span class="detail-label">Hospital/Clinic:</span>
      <span class="detail-value">{{ .Followup.HospitalName }}</span>
    </div>
    {{ if .Followup.Notes }}
    <div class="detail-item">
      <span class="detail-label">Notes:</span>
      <span class="detail-value">{{ .Followup.Notes }}</span>
    </div>
    {{ end }}
  </div>

  <!-- Lab Results Section -->
  <div class="detail-section">
    <h3>Lab Test Results</h3>

    <!-- AI Summary -->
    <div class="ai-summary-section">
      <input type="hidden" id="csrf-token" value="{{ .csrf_token }}" />
      <button type="button" id="ai-summary-btn" class="btn">✨ AI Summary</button>
      <div id="ai-summary-output" class="ai-summary-output"></div>
    </div>

    {{ if .IsAdmin }}
    <!-- Add Result Form -->
    <details class="add-item-details">
      <summary class="add-item-summary">+ Add Lab Result</summary>
      <form method="POST" action="/health/{{ .Profile.ID }}/followup/{{ .Followup.ID }}/result" class="add-item-form">
        <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
        <div class="form-group">
          <label for="test_name" class="item-title">Test <span class="required">*</span></label>
          <select id="test_name" name="test_name" class="form-item" required onchange="updateUnit()">
            <option value="">-- Select a test --</option>
            {{ range .Categories }}
              {{ $category := . }}
              <optgroup label="{{ $category }}">
                {{ range $.PredefinedTests }}
                  {{ if eq .Category $category }}
                    {{ $isDisabled := index $.ExistingTests .Name }}
                    <option value="{{ .Name }}" data-unit="{{ .Unit }}" {{ if $isDisabled }}disabled{{ end }}>
                      {{ .Name }} ({{ .Unit }}){{ if $isDisabled }} - Already added{{ end }}
                    </option>
                  {{ end }}
                {{ end }}
              </optgroup>
            {{ end }}
          </select>
        </div>
        <div class="form-group">
          <label for="test_unit" class="item-title">Unit</label>
          <input type="text" id="test_unit" name="test_unit" class="form-item" readonly>
          <small class="muted-text">Auto-filled based on selected test</small>
        </div>
        <div class="form-group">
          <label for="test_value" class="item-title">Value <span class="required">*</span></label>
          <input type="number" step="0.001" id="test_value" name="test_value" class="form-item" required
                 placeholder="e.g., 145.5">
        </div>
        <div class="form-group">
          <button type="submit" class="btn">Add Result</button>
        </div>
      </form>
    </details>
    {{ end }}

    <!-- Display Results Grouped by Category -->
    {{ if .Results }}
      {{ range .Categories }}
        {{ $category := . }}
        {{ $categoryResults := index $.Results $category }}
        {{ if $categoryResults }}
        <div class="detail-section">
          <h4>{{ $category }}</h4>
          {{ range $categoryResults }}
          <div class="detail-card">
            <div class="detail-card-content">
              <div class="detail-card-value">
                <strong>{{ .TestName }}</strong>:
                {{ if eq .RangeStatus "out_of_reference" }}
                  <span class="lab-value-critical">{{ printf "%.3f" .TestValue }}</span>
                {{ else if eq .RangeStatus "out_of_optimal" }}
                  <span class="lab-value-warning">{{ printf "%.3f" .TestValue }}</span>
                {{ else }}
                  <span>{{ printf "%.3f" .TestValue }}</span>
                {{ end }}
                {{ if .TestUnit }} {{ .TestUnit }}{{ end }}
                {{ if .ArrowDirection }}
                  {{ if eq .RangeStatus "out_of_reference" }}
                    {{ if eq .ArrowDirection "up" }}
                      <span class="lab-arrow lab-arrow-critical" title="Above reference range">↑</span>
                    {{ else }}
                      <span class="lab-arrow lab-arrow-critical" title="Below reference range">↓</span>
                    {{ end }}
                  {{ else if eq .RangeStatus "out_of_optimal" }}
                    {{ if eq .ArrowDirection "up" }}
                      <span class="lab-arrow lab-arrow-warning" title="Above optimal range">↑</span>
                    {{ else }}
                      <span class="lab-arrow lab-arrow-warning" title="Below optimal range">↓</span>
                    {{ end }}
                  {{ end }}
                {{ end }}
                {{ if .IsCalculated }}<span class="muted-text calculated-label"> (calculated)</span>{{ end }}
              </div>
              {{ if .HasRanges }}
              <div class="lab-ranges">
                <span class="range-label">Reference:</span>
                <span class="range-value">
                  {{ if and .RefMin .RefMax }}
                    {{ printf "%.2f" .RefMin }} - {{ printf "%.2f" .RefMax }}
                  {{ else if .RefMax }}
                    &lt; {{ printf "%.2f" .RefMax }}
                  {{ else if .RefMin }}
                    &gt; {{ printf "%.2f" .RefMin }}
                  {{ else }}
                    N/A
                  {{ end }}
                </span>
                {{ if .HasOptimal }}
                <span class="range-separator">|</span>
                <span class="range-label">Optimal:</span>
                <span class="range-value">
                  {{ if and .OptMin .OptMax }}
                    {{ printf "%.2f" .OptMin }} - {{ printf "%.2f" .OptMax }}
                  {{ else if .OptMax }}
                    &lt; {{ printf "%.2f" .OptMax }}
                  {{ else if .OptMin }}
                    &gt; {{ printf "%.2f" .OptMin }}
                  {{ else }}
                    N/A
                  {{ end }}
                </span>
                {{ end }}
              </div>
              {{ end }}
              <div class="detail-card-meta">
                {{ if .IsCalculated }}
                <span class="muted-text">Calculated from WBC and percentage</span>
                {{ else }}
                <span class="muted-text">Recorded: {{ .CreatedAt.Format "Jan 2, 2006 3:04 PM" }}</span>
                {{ end }}
              </div>
            </div>
            {{ if and $.IsAdmin (not .IsCalculated) }}
            <div class="detail-card-actions">
              <a href="/health/{{ $.Profile.ID }}/followup/{{ $.Followup.ID }}/result/{{ .ID }}/edit" class="btn-edit" title="Edit">✎</a>
              <form method="POST" action="/health/{{ $.Profile.ID }}/followup/{{ $.Followup.ID }}/result/{{ .ID }}/delete" class="item-delete-form" onsubmit="return confirm('Delete this test result?');">
                <input type="hidden" name="_csrf" value="{{ $.csrf_token }}" />
                <button type="submit" class="btn-delete" title="Delete">×</button>
              </form>
            </div>
            {{ end }}
          </div>
          {{ end }}
        </div>
        {{ end }}
      {{ end }}
    {{ else }}
    <p class="muted-text">No lab results recorded yet.</p>
    {{ end }}
  </div>
</div>

<script type="module">
import { marked } from 'https://cdnjs.cloudflare.com/ajax/libs/marked/16.3.0/lib/marked.esm.js';

function updateUnit() {
  const select = document.getElementById('test_name');
  const unitInput = document.getElementById('test_unit');
  const selectedOption = select.options[select.selectedIndex];
  const unit = selectedOption.getAttribute('data-unit');
  unitInput.value = unit || '';
}
window.updateUnit = updateUnit;

(function() {
  const btn = document.getElementById('ai-summary-btn');
  const output = document.getElementById('ai-summary-output');
  const csrfToken = document.getElementById('csrf-token');

  if (btn && output && csrfToken) {
    btn.addEventListener('click', async function() {
      btn.disabled = true;
      btn.textContent = 'Generating...';
      output.innerHTML = '';
      output.style.display = 'block';

      let fullText = '';

      try {
        const response = await fetch(window.location.pathname + '/ai-summary', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': csrfToken.value
          }
        });

        if (!response.ok) {
          throw new Error('Server returned ' + response.status);
        }

        // Read SSE stream
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });

          // Process complete SSE messages
          const lines = buffer.split('\n');
          buffer = lines.pop(); // Keep incomplete line in buffer

          let currentEvent = '';
          for (const line of lines) {
            if (line.startsWith('event: ')) {
              currentEvent = line.substring(7);
            } else if (line.startsWith('data: ')) {
              const data = line.substring(6);

              if (currentEvent === 'error') {
                output.textContent = 'Error: ' + data;
                return;
              } else if (currentEvent === 'chunk') {
                fullText += data;
                output.innerHTML = marked.parse(fullText);
              } else if (currentEvent === 'done') {
                // Generation complete
                return;
              }
            }
          }
        }
      } catch (err) {
        output.textContent = 'Error: ' + err.message;
      } finally {
        btn.disabled = false;
        btn.textContent = '✨ AI Summary';
      }
    });
  }
})();
</script>

{{ template "foot" . }}
