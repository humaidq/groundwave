{{ template "head" . }}

{{ if .Error }}
<div class="alert alert-red">
  <h5 class="alert-title">Error</h5>
  <p>{{.Error}}</p>
</div>
{{ end }}

{{ if .Breadcrumbs }}
<nav class="breadcrumb" aria-label="Breadcrumb">
  {{ range $i, $b := .Breadcrumbs }}
    {{ if $i }}<span class="breadcrumb-separator">&gt;</span>{{ end }}
    {{ if $b.IsCurrent }}
      <span class="breadcrumb-current">{{ $b.Name }}</span>
    {{ else }}
      <a href="{{ $b.URL }}" class="breadcrumb-item">{{ $b.Name }}</a>
    {{ end }}
  {{ end }}
</nav>
{{ end }}

<div class="page-header">
  <h2>Security</h2>
  <div class="page-header-actions">
    <form method="POST" action="/security/invalidate-other" class="inline-form">
      <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
      {{ if .IsAdmin }}
      <button type="submit" class="btn">Invalidate All Sessions</button>
      {{ else }}
      <button type="submit" class="btn">Invalidate Other Sessions</button>
      {{ end }}
    </form>
  </div>
</div>

<div class="section-heading">Passkeys</div>

<div class="alert alert-red hidden" data-webauthn-error>
  <h5 class="alert-title">Error</h5>
  <p data-webauthn-error-message></p>
</div>

<div class="form-group">
  <label for="passkey-label" class="item-title">New passkey label (optional)</label>
  <input type="text" id="passkey-label" class="form-item" placeholder="MacBook Pro, iPhone" />
</div>

<div class="form-group">
  <button
    type="button"
    class="btn"
    data-webauthn-register
    data-start-url="/webauthn/passkey/start"
    data-finish-url="/webauthn/passkey/finish"
    data-passkey-label-input="#passkey-label"
  >Add passkey</button>
</div>

{{ if .Passkeys }}
<div class="list-card-list">
  {{ range .Passkeys }}
  <div class="list-card">
    <div class="list-card-title">{{ .Label }}</div>
    <div class="list-card-meta">
      <span class="muted-text">Created {{ .CreatedAt.Format "Jan 2, 2006" }}</span>
      {{ if .LastUsed }}
      <span class="muted-text" title="{{ .LastUsed.Format "Jan 2, 2006 15:04" }}">Last used {{ .LastUsed.Format "Jan 2, 2006" }}</span>
      {{ else }}
      <span class="muted-text">Never used</span>
      {{ end }}
    </div>
    {{ if gt $.PasskeyCount 1 }}
    <div class="list-card-meta">
      <form method="POST" action="/security/passkeys/{{ .ID }}/delete" class="inline-form">
        <input type="hidden" name="_csrf" value="{{ $.csrf_token }}" />
        <button type="submit" class="btn btn-danger">Delete</button>
      </form>
    </div>
    {{ end }}
  </div>
  {{ end }}
</div>
{{ else }}
<p class="muted-text">No passkeys registered.</p>
{{ end }}

<script src="/webauthn.js" defer></script>

{{ if .IsAdmin }}
<div class="section-heading">Accounts</div>

{{ if .AccountError }}
<div class="alert alert-red">
  <h5 class="alert-title">Error</h5>
  <p>{{ .AccountError }}</p>
</div>
{{ else if .Accounts }}
<div class="list-card-list">
  {{ range .Accounts }}
  <div class="list-card">
    <div class="list-card-title">
      {{ .DisplayName }}
      {{ if .IsAdmin }}<span class="badge ml-half">Admin</span>{{ end }}
      {{ if .IsCurrent }}<span class="badge ml-half">Current</span>{{ end }}
    </div>
    <div class="list-card-meta">
      <span class="muted-text">Created {{ .CreatedAt.Format "Jan 2, 2006" }}</span>
    </div>
    {{ if .CanDelete }}
    <div class="list-card-meta">
      <form method="POST" action="/security/users/{{ .ID }}/delete" class="inline-form" onsubmit="return confirm('Delete this account?');">
        <input type="hidden" name="_csrf" value="{{ $.csrf_token }}" />
        <button type="submit" class="btn btn-danger">Delete</button>
      </form>
    </div>
    {{ end }}
  </div>
  {{ end }}
</div>
{{ else }}
<p class="muted-text">No accounts found.</p>
{{ end }}

<div class="section-heading">User Provisioning</div>

{{ if .InviteError }}
<div class="alert alert-red">
  <h5 class="alert-title">Error</h5>
  <p>{{ .InviteError }}</p>
</div>
{{ end }}

<form method="POST" action="/security/invites" class="form-group">
  <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
  <label for="invite-display-name" class="item-title">Display name (optional)</label>
  <input type="text" id="invite-display-name" name="display_name" class="form-item" placeholder="Guest" />
  <p class="muted-text">Invites expire 24 hours after creation.</p>
  <div class="form-group">
    <button type="submit" class="btn">Create invite</button>
  </div>
</form>

{{ if .UserInvites }}
<div class="list-card-list">
  {{ range .UserInvites }}
  <div class="list-card">
    <div class="list-card-title">{{ .DisplayName }}</div>
    <div class="list-card-meta">
      <span class="muted-text">Created {{ .CreatedAt.Format "Jan 2, 2006" }}</span>
      <span class="muted-text" title="{{ .ExpiresAt.Format "Jan 2, 2006 15:04" }}">Expires {{ .ExpiresIn }}</span>
    </div>
    {{ if .QRCode }}
    <div class="qr-container">
      <img src="data:image/png;base64,{{ .QRCode }}" alt="Setup QR code" class="qr-code" />
    </div>
    {{ end }}
    <div class="list-card-meta">
      <a href="{{ .SetupURL }}" class="btn" target="_blank" rel="noreferrer">Open setup link</a>
      <form method="POST" action="/security/invites/{{ .ID }}/delete" class="inline-form" onsubmit="return confirm('Revoke this invite?');">
        <input type="hidden" name="_csrf" value="{{ $.csrf_token }}" />
        <button type="submit" class="btn btn-danger">Revoke</button>
      </form>
    </div>
  </div>
  {{ end }}
</div>
{{ else }}
<p class="muted-text">No pending invites.</p>
{{ end }}

{{ if .ExpiredUserInvites }}
<p class="muted-text">Expired invites (regenerate to issue a new setup link):</p>
<div class="list-card-list">
  {{ range .ExpiredUserInvites }}
  <div class="list-card">
    <div class="list-card-title">{{ .DisplayName }}</div>
    <div class="list-card-meta">
      <span class="muted-text">Created {{ .CreatedAt.Format "Jan 2, 2006" }}</span>
      <span class="muted-text" title="{{ .ExpiresAt.Format "Jan 2, 2006 15:04" }}">Expired {{ .ExpiresAt.Format "Jan 2, 2006" }}</span>
    </div>
    <div class="list-card-meta">
      <form method="POST" action="/security/invites/{{ .ID }}/regenerate" class="inline-form" onsubmit="return confirm('Regenerate this invite link?');">
        <input type="hidden" name="_csrf" value="{{ $.csrf_token }}" />
        <button type="submit" class="btn">Regenerate link</button>
      </form>
      <form method="POST" action="/security/invites/{{ .ID }}/delete" class="inline-form" onsubmit="return confirm('Delete this expired invite?');">
        <input type="hidden" name="_csrf" value="{{ $.csrf_token }}" />
        <button type="submit" class="btn btn-danger">Delete</button>
      </form>
    </div>
  </div>
  {{ end }}
</div>
{{ end }}

<div class="section-heading">Health Sharing</div>

{{ if .ShareError }}
<div class="alert alert-red">
  <h5 class="alert-title">Error</h5>
  <p>{{ .ShareError }}</p>
</div>
{{ end }}

{{ if .UserShares }}
  {{ if .ShareProfiles }}
    {{ range .UserShares }}
    {{ $user := . }}
    <div class="detail-section">
      <h3>{{ $user.DisplayName }}</h3>
      <form method="POST" action="/security/users/{{ $user.ID }}/health-shares" class="form-group">
        <input type="hidden" name="_csrf" value="{{ $.csrf_token }}" />
        <div class="tag-dropdown-list">
          {{ range $.ShareProfiles }}
          <label class="tag-checkbox-item">
            <input type="checkbox" name="profile_id" value="{{ .ID }}"{{ if index $user.SharedProfileIDs .ID }} checked{{ end }}>
            <span class="tag-checkbox-label">{{ .Name }}</span>
            {{ if .IsPrimary }}<span class="badge ml-half">Primary</span>{{ end }}
          </label>
          {{ end }}
        </div>
        <div class="form-group">
          <button type="submit" class="btn">Save sharing</button>
        </div>
      </form>
    </div>
    {{ end }}
  {{ else }}
  <p class="muted-text">No health profiles available to share.</p>
  {{ end }}
{{ else }}
<p class="muted-text">No non-admin users found.</p>
{{ end }}
{{ end }}

<div class="section-heading">Sessions</div>

{{ if .Sessions }}
<div class="list-card-list">
  {{ range .Sessions }}
  <div class="list-card">
    <div class="list-card-title">
      {{ .Device }}
      {{ if .IsCurrent }}<span class="badge">Current</span>{{ end }}
    </div>
    <div class="list-card-meta">
      {{ if $.IsAdmin }}
      <span class="muted-text">User: {{ .UserName }}</span>
      {{ end }}
      <span class="muted-text">IP: {{ .IP }}</span>
      <span class="muted-text" title="{{ .ExpiresAt.Format "Jan 2, 2006 15:04" }}">Expires {{ .ExpiresIn }}</span>
    </div>
    <div class="list-card-meta">
      <form method="POST" action="/security/sessions/{{ .ID }}/invalidate" class="inline-form" onsubmit="return confirm('Invalidate this session?');">
        <input type="hidden" name="_csrf" value="{{ $.csrf_token }}" />
        <button type="submit" class="btn btn-danger">Invalidate</button>
      </form>
    </div>
  </div>
  {{ end }}
</div>
{{ else }}
<p class="muted-text">No active sessions found.</p>
{{ end }}

{{ template "foot" . }}
