{{ template "head" . }}

{{ if .Error }}
<div class="alert alert-red">
  <h5 class="alert-title">Error</h5>
  <p>{{.Error}}</p>
</div>
{{ end }}

{{ if .Breadcrumbs }}
<nav class="breadcrumb" aria-label="Breadcrumb">
  {{ range $i, $b := .Breadcrumbs }}
    {{ if $i }}<span class="breadcrumb-separator">&gt;</span>{{ end }}
    {{ if $b.IsCurrent }}
      <span class="breadcrumb-current">{{ $b.Name }}</span>
    {{ else }}
      <a href="{{ $b.URL }}" class="breadcrumb-item">{{ $b.Name }}</a>
    {{ end }}
  {{ end }}
</nav>
{{ end }}

<div class="page-header">
  <h2>Security</h2>
  <div class="page-header-actions">
    <form method="POST" action="/security/invalidate-other" class="inline-form">
      <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
      <button type="submit" class="btn">Invalidate Other Sessions</button>
    </form>
  </div>
</div>

<div class="section-heading">Passkeys</div>

<div class="alert alert-red hidden" data-webauthn-error>
  <h5 class="alert-title">Error</h5>
  <p data-webauthn-error-message></p>
</div>

<div class="form-group">
  <label for="passkey-label" class="item-title">New passkey label (optional)</label>
  <input type="text" id="passkey-label" class="form-item" placeholder="MacBook Pro, iPhone" />
</div>

<div class="form-group">
  <button
    type="button"
    class="btn"
    data-webauthn-register
    data-start-url="/webauthn/passkey/start"
    data-finish-url="/webauthn/passkey/finish"
    data-passkey-label-input="#passkey-label"
  >Add passkey</button>
</div>

{{ if .Passkeys }}
<div class="list-card-list">
  {{ range .Passkeys }}
  <div class="list-card">
    <div class="list-card-title">{{ .Label }}</div>
    <div class="list-card-meta">
      <span class="muted-text">Created {{ .CreatedAt.Format "Jan 2, 2006" }}</span>
      {{ if .LastUsed }}
      <span class="muted-text" title="{{ .LastUsed.Format "Jan 2, 2006 15:04" }}">Last used {{ .LastUsed.Format "Jan 2, 2006" }}</span>
      {{ else }}
      <span class="muted-text">Never used</span>
      {{ end }}
    </div>
    {{ if gt $.PasskeyCount 1 }}
    <div class="list-card-meta">
      <form method="POST" action="/security/passkeys/{{ .ID }}/delete" class="inline-form">
        <input type="hidden" name="_csrf" value="{{ $.csrf_token }}" />
        <button type="submit" class="btn btn-danger">Delete</button>
      </form>
    </div>
    {{ end }}
  </div>
  {{ end }}
</div>
{{ else }}
<p class="muted-text">No passkeys registered.</p>
{{ end }}

<script src="/webauthn.js" defer></script>

<div class="section-heading">Sessions</div>

{{ if .Sessions }}
<div class="list-card-list">
  {{ range .Sessions }}
  <div class="list-card">
    <div class="list-card-title">
      {{ .Device }}
      {{ if .IsCurrent }}<span class="badge">Current</span>{{ end }}
    </div>
    <div class="list-card-meta">
      <span class="muted-text">IP: {{ .IP }}</span>
      <span class="muted-text" title="{{ .ExpiresAt.Format "Jan 2, 2006 15:04" }}">Expires {{ .ExpiresIn }}</span>
    </div>
  </div>
  {{ end }}
</div>
{{ else }}
<p class="muted-text">No active sessions found.</p>
{{ end }}

{{ template "foot" . }}
