{{ template "head" . }}

{{ if .Breadcrumbs }}
<nav class="breadcrumb" aria-label="Breadcrumb">
  {{ range $i, $b := .Breadcrumbs }}
    {{ if $i }}<span class="breadcrumb-separator">&gt;</span>{{ end }}
    {{ if $b.IsCurrent }}
      <span class="breadcrumb-current">{{ $b.Name }}</span>
    {{ else }}
      <a href="{{ $b.URL }}" class="breadcrumb-item">{{ $b.Name }}</a>
    {{ end }}
  {{ end }}
</nav>
{{ end }}

{{ if .Error }}
<div class="alert alert-red">
  {{ .Error }}
</div>
{{ end }}

<div class="page-header">
  <div class="page-header-stack">
    <h2>{{ .Item.InventoryID }} - {{ .Item.Name }}</h2>
    <div class="page-header-meta">
      <span class="status-badge status-{{ .Item.Status }}">{{ inventoryStatusLabel .Item.Status }}</span>
      {{ with .Item.ItemType }}<span class="tag-badge">{{ . }}</span>{{ end }}
    </div>
  </div>
  <div class="page-header-actions">
    {{ if .IsAdmin }}
    <a href="/inventory/{{ .Item.InventoryID }}/edit" class="btn">Edit</a>
    <form method="POST" action="/inventory/{{ .Item.InventoryID }}/delete" class="inline-form" onsubmit="return confirm('Delete this inventory item? This cannot be undone.');">
      <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
      <button type="submit" class="btn btn-danger">Delete</button>
    </form>
    {{ end }}
  </div>
</div>

<div class="detail-layout">
  <!-- Item Details -->
  <div class="detail-section">
    {{ with .Item.Location }}
    <div class="detail-item">
      <span class="detail-label">Location:</span>
      <span class="detail-value">{{ . }}</span>
    </div>
    {{ end }}
    {{ with .Item.ItemType }}
    <div class="detail-item">
      <span class="detail-label">Type:</span>
      <span class="detail-value">{{ . }}</span>
    </div>
    {{ end }}
    {{ with .Item.InspectionDate }}
    <div class="detail-item">
      <span class="detail-label">Inspection Date:</span>
      <span class="detail-value">{{ .Format "Jan 2, 2006" }}{{ if $.Item.InspectionDue }} <span class="status-badge status-inspection_due">Inspection Due</span>{{ end }}</span>
    </div>
    {{ end }}
    <div class="detail-item">
      <span class="detail-label">Created:</span>
      <span class="detail-value">{{ .Item.CreatedAt.Format "Jan 2, 2006 3:04 PM" }}</span>
    </div>
  </div>

  {{ with .Item.Description }}
  <!-- Description Section -->
  <div class="detail-section">
    <h3>Description</h3>
    <div class="pre-line">{{ . }}</div>
  </div>
  {{ end }}

  <div class="detail-section">
    <h3>Tags</h3>
    {{ if .Item.Tags }}
    <div class="tag-pills">
      {{ range .Item.Tags }}
      <div class="tag-pill">
        <a href="/inventory?q=tag:{{ .Name | urlquery }}" class="tag-pill-link">
          <span class="tag-pill-name">{{ .Name }}</span>
        </a>
        {{ if $.IsAdmin }}
        <form method="POST" action="/inventory/{{ $.Item.InventoryID }}/tag/{{ .ID }}/delete" class="tag-pill-delete-form" onsubmit="return confirm('Remove this tag?');">
          <input type="hidden" name="_csrf" value="{{ $.csrf_token }}" />
          <button type="submit" class="tag-pill-delete-btn" title="Remove">×</button>
        </form>
        {{ end }}
      </div>
      {{ end }}
    </div>
    {{ else }}
    <p class="no-comments">No tags yet.</p>
    {{ end }}

    {{ if .IsAdmin }}
    <details class="add-item-details">
      <summary class="add-item-summary">+ Add Tag</summary>
      <form method="POST" action="/inventory/{{ .Item.InventoryID }}/tag" class="add-item-form">
        <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
        <div class="add-item-field">
          <div class="autocomplete-container">
            <input type="text" name="tag_name" id="inventory-tag-autocomplete" placeholder="Tag name" required class="form-item" pattern="[a-z0-9._:/-]+( [a-z0-9._:/-]+)*" title="Lowercase letters, numbers, spaces, and ._:/- characters only" autocomplete="off">
            <div class="autocomplete-dropdown" id="inventory-tag-dropdown"></div>
          </div>
          <p class="help-text">Use plain lowercase labels (e.g., critical, has battery, needs calibration).</p>
        </div>
        <button type="submit" class="btn">Add Tag</button>
      </form>
    </details>
    {{ end }}
  </div>

  <!-- Files Section -->
  <div class="detail-section">
    <h3>Files</h3>
    {{ if .InventoryFilesURL }}
    <div class="section-actions">
      <a href="{{ .InventoryFilesURL }}" class="btn"{{ if and .IsAdmin .InventoryFilesMissing }} id="inventory-open-files-btn"{{ end }}>Open in Files</a>
    </div>
    {{ if and .IsAdmin .InventoryFilesMissing }}
    <form id="inventory-create-files-folder-form" method="POST" action="/files/mkdir" style="display: none;">
      <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
      <input type="hidden" name="path" value="{{ .InventoryFilesParentPath }}" />
      <input type="hidden" name="dir_name" value="{{ .InventoryFilesDirName }}" />
      <input type="hidden" name="redirect_to" value="{{ .InventoryFilesURL }}" />
    </form>
    {{ end }}
    {{ end }}
    {{ if .Files }}
    <ul class="file-list">
      {{ range .Files }}
      <li class="file-item">
        <a href="/inventory/{{ $.Item.InventoryID }}/file/{{ .Name }}" class="file-link" target="_blank">
          <i class="fa-solid fa-file" aria-hidden="true"></i> {{ .Name }}
        </a>
        <span class="file-meta">{{ formatFileSize .Size }} | {{ .ModTime.Format "Jan 2, 2006" }}</span>
      </li>
      {{ end }}
    </ul>
    {{ else }}
    <p class="no-files">No files...</p>
    {{ end }}
  </div>

  {{ if .IsAdmin }}
  <!-- Comments Section -->
  <div class="detail-section">
    <h3>Comments</h3>
    {{ if .Comments }}
    <div class="log-list">
      {{ range .Comments }}
      <div class="log-entry">
        <div class="log-header">
          <span class="log-type log-type-note">comment</span>
          <span class="log-date">{{ .CreatedAt.Format "Jan 2, 2006 3:04 PM" }}</span>
          <form method="POST" action="/inventory/{{ $.Item.InventoryID }}/comment/{{ .ID }}/delete" class="log-delete-form" onsubmit="return confirm('Delete this comment?');">
            <input type="hidden" name="_csrf" value="{{ $.csrf_token }}" />
            <button type="submit" class="btn-delete" title="Delete">×</button>
          </form>
        </div>
        <div class="log-content">{{ .Content }}</div>
      </div>
      {{ end }}
    </div>
    {{ else }}
    <p class="no-comments">No comments yet.</p>
    {{ end }}

    <!-- Add Comment Form -->
    <details class="add-item-details" open>
      <summary class="add-item-summary">+ Add Comment</summary>
      <form method="POST" action="/inventory/{{ .Item.InventoryID }}/comment" class="add-item-form">
        <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
        <div class="add-item-field">
          <textarea name="content" placeholder="Add a comment..." required class="form-item" rows="4"></textarea>
        </div>
        <button type="submit" class="btn">Post Comment</button>
      </form>
    </details>
  </div>
  {{ end }}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var tagNames = [{{ range $i, $t := .AllTags }}{{ if $i }}, {{ end }}"{{ $t.Name }}"{{ end }}];
  if (tagNames.length > 0) {
    initAutocomplete('#inventory-tag-autocomplete', tagNames);
  }

  var openInFilesButton = document.getElementById('inventory-open-files-btn');
  if (openInFilesButton) {
    openInFilesButton.addEventListener('click', function(event) {
      event.preventDefault();

      var shouldCreate = window.confirm('This folder does not exist yet. Create it before opening in Files?');
      if (!shouldCreate) {
        window.location.assign(openInFilesButton.getAttribute('href'));
        return;
      }

      var createFolderForm = document.getElementById('inventory-create-files-folder-form');
      if (createFolderForm) {
        createFolderForm.submit();
        return;
      }

      window.location.assign(openInFilesButton.getAttribute('href'));
    });
  }
});
</script>

{{ template "foot" . }}
