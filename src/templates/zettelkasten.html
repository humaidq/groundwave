{{ template "head" . }}

{{ if .ZKHistory }}
<nav class="breadcrumb" aria-label="Navigation history">
  {{ range $i, $h := .ZKHistory }}
    {{ if $i }}<span class="breadcrumb-separator">&gt;</span>{{ end }}
    {{ if $h.IsCurrent }}
      <span class="breadcrumb-current">{{ truncateBreadcrumb $h.Title }}</span>
    {{ else }}
      <a href="/zk/{{ $h.ID }}" class="breadcrumb-item">{{ truncateBreadcrumb $h.Title }}</a>
    {{ end }}
  {{ end }}
</nav>
{{ end }}

{{ if .Error }}
  <div class="zk-error">
    <h2>Error Loading Note</h2>
    <p>{{ .Error }}</p>
    {{ if .BackLink }}
      <p><a href="{{ .BackLink }}" class="zk-link">← Return to Index</a></p>
    {{ end }}
  </div>
{{ else }}
  <div class="zk-note">
    <header class="zk-header">
      <div class="page-header-actions">
        {{ template "zk_header_actions" . }}
      </div>
      {{ if and .Note.IsPublic .PublishPath }}
      <div class="zk-published" data-publish-path="{{ .PublishPath }}">
        <div class="btn-pill">
          <span class="btn-pill-label">Published</span>
          <button type="button" class="btn-pill-action zk-copy-link">Copy Link</button>
        </div>
        <span class="zk-copy-status" aria-live="polite"></span>
      </div>
      {{ end }}
    </header>

    <div class="zk-content">
      {{ .Note.HTMLBody }}
    </div>

    <!-- Backlinks Section -->
    {{ if .Backlinks }}
    <div class="backlinks-section">
      <h3>Backlinks ({{ len .Backlinks }})</h3>
      <p class="backlinks-description">Notes that link to this page:</p>
      <ul class="backlinks-list">
        {{ range .Backlinks }}
        <li><a href="{{ .URL }}">{{ .Title }}</a></li>
        {{ end }}
      </ul>
    </div>
    {{ end }}

    <!-- Cache Info -->
    <div class="cache-info">
      {{ if .LastCacheUpdate.IsZero }}
      <small>Links index not yet built...</small>
      {{ else }}
      <small>Links last updated: {{ .LastCacheUpdate.Format "Jan 2, 2006 3:04 PM" }}</small>
      {{ end }}
      <form method="POST" action="/rebuild-cache" class="inline-form" onsubmit="return confirm('This will rebuild caches and may take a minute. Continue?');">
        <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
        <button type="submit" class="btn-small">Refresh Now</button>
      </form>
    </div>

    <!-- Comments Section -->
    <div class="zk-comments-section">
      <div class="zk-comments-header">
        <h3>Comments</h3>
        {{ if and (gt (len .Comments) 1) .NoteID }}
        <form method="POST" action="/zk/{{ .NoteID }}/comments/delete" class="log-delete-form" onsubmit="return confirm('Delete all comments?');">
          <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
          <button type="submit" class="btn-delete" title="Delete all comments" aria-label="Delete all comments">×</button>
        </form>
        {{ end }}
      </div>

      {{ if .Comments }}
      <div class="log-list">
        {{ range .Comments }}
        <div class="log-entry">
          <div class="log-header">
            <span class="log-type log-type-note">comment</span>
            <span class="log-date">{{ .CreatedAt.Format "Jan 2, 2006 3:04 PM" }}</span>
            <form method="POST" action="/zk/{{ $.NoteID }}/comment/{{ .ID }}/delete" class="log-delete-form" onsubmit="return confirm('Delete this comment?');">
              <input type="hidden" name="_csrf" value="{{ $.csrf_token }}" />
              <button type="submit" class="btn-delete" title="Delete">×</button>
            </form>
          </div>
          <div class="log-content">{{ .Content }}</div>
        </div>
        {{ end }}
      </div>
      {{ else }}
      <p class="no-comments">No comments yet.</p>
      {{ end }}

      <!-- Always-visible comment form (NOT collapsible) -->
      <div class="zk-comment-form">
        <h4>Add Comment</h4>
        <form method="POST" action="/zk/{{ .NoteID }}/comment" class="comment-form">
          <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
          <div class="form-field">
            <textarea name="content" id="comment_content" class="form-item" rows="4" placeholder="Add a temporary comment..." required></textarea>
          </div>
          <button type="submit" class="btn">Post Comment</button>
        </form>
      </div>
    </div>
  </div>
{{ end }}

{{ if and .Note.IsPublic .PublishPath }}
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const container = document.querySelector(".zk-published");
    if (!container) {
      return;
    }
    const button = container.querySelector(".zk-copy-link");
    const status = container.querySelector(".zk-copy-status");
    const path = container.getAttribute("data-publish-path");
    if (!button || !status || !path) {
      return;
    }
    button.addEventListener("click", function() {
      const url = new URL(path, window.location.origin);
      if (!navigator.clipboard) {
        status.textContent = "Clipboard unavailable";
        return;
      }
      navigator.clipboard.writeText(url.toString()).then(function() {
        status.textContent = "Copied";
      }).catch(function() {
        status.textContent = "Copy failed";
      });
    });
  });
</script>
{{ end }}

{{ template "foot" . }}
