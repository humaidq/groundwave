{{ template "head" . }}

{{ if .Breadcrumbs }}
<nav class="breadcrumb" aria-label="Breadcrumb">
  {{ range $i, $b := .Breadcrumbs }}
    {{ if $i }}<span class="breadcrumb-separator">&gt;</span>{{ end }}
    {{ if $b.IsCurrent }}
      <span class="breadcrumb-current">{{ $b.Name }}</span>
    {{ else }}
      <a href="{{ $b.URL }}" class="breadcrumb-item">{{ $b.Name }}</a>
    {{ end }}
  {{ end }}
</nav>
{{ end }}

<div class="page-header">
  <h2>Inventory</h2>
  {{ if .IsAdmin }}
  <a href="/inventory/new" class="btn">+ Add Item</a>
  {{ end }}
</div>

{{ if .Error }}
<div class="alert alert-red">
  {{ .Error }}
</div>
{{ end }}

<div class="tag-filter-section">
  <form method="GET" action="/inventory" class="tag-filter-form">
    <div class="tag-dropdown-container">
      <button type="button" class="btn tag-dropdown-toggle" id="statusDropdownToggle">
        <span class="dropdown-label">Filter by Status</span>
        {{ if .StatusFilter }}
        <span class="tag-count-badge">1</span>
        {{ end }}
        <span class="dropdown-arrow">‚ñº</span>
      </button>

      <div class="tag-dropdown-menu" id="statusDropdownMenu">
        <div class="tag-dropdown-header">
          <span class="dropdown-title">Filter by status</span>
        </div>
        <div class="tag-dropdown-list">
          {{ range .StatusOptions }}
          <label class="tag-checkbox-item">
            <input type="radio" name="status" value="{{ .Value }}"{{ if eq $.StatusFilter .Value }} checked{{ end }}>
            <span class="tag-checkbox-label">{{ .Label }}</span>
          </label>
          {{ end }}
        </div>
        <div class="tag-dropdown-footer">
          <button type="submit" class="btn">Apply</button>
          <a href="/inventory" class="btn">Clear</a>
        </div>
      </div>
    </div>
  </form>
</div>

<script>
(function() {
  const toggle = document.getElementById('statusDropdownToggle');
  const menu = document.getElementById('statusDropdownMenu');

  if (toggle && menu) {
    toggle.addEventListener('click', function(e) {
      e.preventDefault();
      menu.classList.toggle('show');
    });

    document.addEventListener('click', function(e) {
      if (!toggle.contains(e.target) && !menu.contains(e.target)) {
        menu.classList.remove('show');
      }
    });
  }
})();
</script>

{{ if .Items }}
<input type="text" id="inventorySearch" placeholder="Search inventory..." class="search-input">

<div class="list-card-list" id="inventoryList">
  {{ range .Items }}
  <div class="list-card">
    <a href="/inventory/{{ .InventoryID }}" class="list-card-link">
      <div class="list-card-title">
        <span class="inventory-id">{{ .InventoryID }}</span> - {{ .Name }}
        {{ if ne .Status "active" }}<span class="status-badge status-{{ .Status }}">{{ inventoryStatusLabel .Status }}</span>{{ end }}
        {{ if .InspectionDue }}<span class="status-badge status-inspection_due">Inspection Due</span>{{ end }}
      </div>
      {{ if or .Location .Description .InspectionDate }}
      <div class="list-card-meta">
        {{ with .Location }}
        <span class="list-card-location">üìç {{ . }}</span>
        {{ end }}
        {{ with .Description }}
        <span class="list-card-description">{{ . }}</span>
        {{ end }}
        {{ with .InspectionDate }}
        <span class="list-card-description">Inspection: {{ .Format "Jan 2, 2006" }}</span>
        {{ end }}
      </div>
      {{ end }}
    </a>
  </div>
  {{ end }}
</div>
{{ else }}
<p class="empty-state">No inventory items yet.{{ if .IsAdmin }} <a href="/inventory/new">Add your first item</a>.{{ end }}</p>
{{ end }}

{{ if .Items }}
<script>
(function() {
  const searchInput = document.getElementById('inventorySearch');
  const inventoryList = document.getElementById('inventoryList');
  const entries = inventoryList.getElementsByClassName('list-card');

  if (searchInput && entries) {
    function matchesFuzzy(text, query) {
      const trimmed = query.trim();
      if (!trimmed) {
        return true;
      }

      const tokens = trimmed.split(/\s+/);
      let index = 0;
      for (let i = 0; i < tokens.length; i++) {
        const token = tokens[i];
        const nextIndex = text.indexOf(token, index);
        if (nextIndex === -1) {
          return false;
        }
        index = nextIndex + token.length;
      }

      return true;
    }

    searchInput.addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase();

      Array.from(entries).forEach(function(entry) {
        const text = entry.textContent.toLowerCase();
        if (matchesFuzzy(text, searchTerm)) {
          entry.style.display = '';
        } else {
          entry.style.display = 'none';
        }
      });
    });
  }
})();
</script>
{{ end }}

{{ template "foot" . }}
