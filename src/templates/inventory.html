{{ template "head" . }}

{{ if .Breadcrumbs }}
<nav class="breadcrumb" aria-label="Breadcrumb">
  {{ range $i, $b := .Breadcrumbs }}
    {{ if $i }}<span class="breadcrumb-separator">&gt;</span>{{ end }}
    {{ if $b.IsCurrent }}
      <span class="breadcrumb-current">{{ $b.Name }}</span>
    {{ else }}
      <a href="{{ $b.URL }}" class="breadcrumb-item">{{ $b.Name }}</a>
    {{ end }}
  {{ end }}
</nav>
{{ end }}

<div class="page-header">
  <h2>Inventory</h2>
  {{ if .IsAdmin }}
  <a href="/inventory/new" class="btn">+ Add Item</a>
  {{ end }}
</div>

{{ if .Error }}
<div class="alert alert-red">
  {{ .Error }}
</div>
{{ end }}

<div class="tag-filter-section">
  <form method="GET" action="/inventory" class="tag-filter-form inventory-filter-form">
    <div class="tag-dropdown-container">
      <button type="button" class="btn tag-dropdown-toggle" id="statusDropdownToggle">
        <span class="dropdown-label">Status</span>
        {{ if .StatusFilter }}
        <span class="tag-count-badge">1</span>
        {{ end }}
        <span class="dropdown-arrow">‚ñº</span>
      </button>

      <div class="tag-dropdown-menu" id="statusDropdownMenu">
        <div class="tag-dropdown-header">
          <span class="dropdown-title">Filter by status</span>
        </div>
        <div class="tag-dropdown-list">
          <label class="tag-checkbox-item">
            <input type="radio" name="status" value=""{{ if eq .StatusFilter "" }} checked{{ end }}>
            <span class="tag-checkbox-label">All statuses</span>
          </label>
          {{ range .StatusOptions }}
          <label class="tag-checkbox-item">
            <input type="radio" name="status" value="{{ .Value }}"{{ if eq $.StatusFilter .Value }} checked{{ end }}>
            <span class="tag-checkbox-label">{{ .Label }}</span>
          </label>
          {{ end }}
        </div>
      </div>
    </div>

    <div class="autocomplete-container inventory-filter-type">
      <input type="text" name="type" id="typeFilterInput" class="form-item" autocomplete="off"
             value="{{ .TypeFilter }}" placeholder="Filter by type"
             pattern="[a-z0-9._:/-]+( [a-z0-9._:/-]+)*"
             title="Lowercase letters, numbers, spaces, and ._:/- characters only">
      <div class="autocomplete-dropdown" id="type-filter-dropdown"></div>
    </div>

    {{ if .AllTags }}
    <div class="tag-dropdown-container">
      <button type="button" class="btn tag-dropdown-toggle" id="tagDropdownToggle">
        <span class="dropdown-label">Tags</span>
        {{ if .SelectedTags }}
        <span class="tag-count-badge">{{ len .SelectedTags }}</span>
        {{ end }}
        <span class="dropdown-arrow">‚ñº</span>
      </button>

      <div class="tag-dropdown-menu" id="tagDropdownMenu">
        <div class="tag-dropdown-header">
          <span class="dropdown-title">Filter by tags</span>
        </div>
        <div class="tag-dropdown-list">
          {{ range .AllTags }}
          <label class="tag-checkbox-item">
            <input type="checkbox" name="tag" value="{{ .ID }}"
              {{- range $.SelectedTags }}{{- if eq . $.ID }} checked{{- end }}{{- end }}>
            <span class="tag-checkbox-label">{{ .Name }}</span>
            <span class="tag-checkbox-count">{{ .UsageCount }}</span>
          </label>
          {{ end }}
        </div>
      </div>
    </div>
    {{ end }}

    <button type="submit" class="btn">Apply</button>
    <a href="/inventory" class="btn">Clear</a>
  </form>
</div>

<script>
(function() {
  const statusToggle = document.getElementById('statusDropdownToggle');
  const statusMenu = document.getElementById('statusDropdownMenu');
  const tagToggle = document.getElementById('tagDropdownToggle');
  const tagMenu = document.getElementById('tagDropdownMenu');

  if (statusToggle && statusMenu) {
    statusToggle.addEventListener('click', function(e) {
      e.preventDefault();
      statusMenu.classList.toggle('show');
      if (tagMenu) {
        tagMenu.classList.remove('show');
      }
    });
  }

  if (tagToggle && tagMenu) {
    tagToggle.addEventListener('click', function(e) {
      e.preventDefault();
      tagMenu.classList.toggle('show');
      if (statusMenu) {
        statusMenu.classList.remove('show');
      }
    });
  }

  document.addEventListener('click', function(e) {
    if (statusToggle && statusMenu && !statusToggle.contains(e.target) && !statusMenu.contains(e.target)) {
      statusMenu.classList.remove('show');
    }
    if (tagToggle && tagMenu && !tagToggle.contains(e.target) && !tagMenu.contains(e.target)) {
      tagMenu.classList.remove('show');
    }
  });

  document.addEventListener('DOMContentLoaded', function() {
    var itemTypes = [{{ range $i, $type := .ItemTypes }}{{ if $i }}, {{ end }}"{{ $type }}"{{ end }}];
    if (itemTypes.length > 0) {
      initAutocomplete('#typeFilterInput', itemTypes);
    }
  });
})();
</script>

{{ if .Items }}
<input type="text" id="inventorySearch" placeholder="Search inventory..." class="search-input">

<div class="list-card-list" id="inventoryList">
  {{ range .Items }}
  <div class="list-card">
    <a href="/inventory/{{ .InventoryID }}" class="list-card-link">
      <div class="list-card-title">
        <span class="inventory-id">{{ .InventoryID }}</span> - {{ .Name }}
        {{ if ne .Status "active" }}<span class="status-badge status-{{ .Status }}">{{ inventoryStatusLabel .Status }}</span>{{ end }}
        {{ if .InspectionDue }}<span class="status-badge status-inspection_due">Inspection Due</span>{{ end }}
        {{ with .ItemType }}<span class="tag-badge">{{ . }}</span>{{ end }}
      </div>
      {{ if or .Location .Description .InspectionDate .Tags }}
      <div class="list-card-meta">
        {{ with .Location }}
        <span class="list-card-location">üìç {{ . }}</span>
        {{ end }}
        {{ with .Description }}
        <span class="list-card-description">{{ . }}</span>
        {{ end }}
        {{ with .InspectionDate }}
        <span class="list-card-description">Inspection: {{ .Format "Jan 2, 2006" }}</span>
        {{ end }}
        {{ if .Tags }}
        <div class="tag-badges">
          {{ range .Tags }}
          <a href="/inventory?tag={{ .ID }}" class="tag-badge"
             onclick="event.stopPropagation(); event.preventDefault(); window.location.href='/inventory?tag={{ .ID }}';">
            {{ .Name }}
          </a>
          {{ end }}
        </div>
        {{ end }}
      </div>
      {{ end }}
    </a>
  </div>
  {{ end }}
</div>
{{ else }}
<p class="empty-state">No inventory items found.{{ if .IsAdmin }} <a href="/inventory/new">Add your first item</a>.{{ end }}</p>
{{ end }}

{{ if .Items }}
<script>
(function() {
  const searchInput = document.getElementById('inventorySearch');
  const inventoryList = document.getElementById('inventoryList');
  const entries = inventoryList.getElementsByClassName('list-card');

  if (searchInput && entries) {
    function matchesFuzzy(text, query) {
      const trimmed = query.trim();
      if (!trimmed) {
        return true;
      }

      const tokens = trimmed.split(/\s+/);
      let index = 0;
      for (let i = 0; i < tokens.length; i++) {
        const token = tokens[i];
        const nextIndex = text.indexOf(token, index);
        if (nextIndex === -1) {
          return false;
        }
        index = nextIndex + token.length;
      }

      return true;
    }

    searchInput.addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase();

      Array.from(entries).forEach(function(entry) {
        const text = entry.textContent.toLowerCase();
        if (matchesFuzzy(text, searchTerm)) {
          entry.style.display = '';
        } else {
          entry.style.display = 'none';
        }
      });
    });
  }
})();
</script>
{{ end }}

{{ template "foot" . }}
