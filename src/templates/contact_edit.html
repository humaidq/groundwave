{{ template "head" . }}

{{ if .Breadcrumbs }}
<nav class="breadcrumb" aria-label="Breadcrumb">
  {{ range $i, $b := .Breadcrumbs }}
    {{ if $i }}<span class="breadcrumb-separator">&gt;</span>{{ end }}
    {{ if $b.IsCurrent }}
      <span class="breadcrumb-current">{{ $b.Name }}</span>
    {{ else }}
      <a href="{{ $b.URL }}" class="breadcrumb-item">{{ $b.Name }}</a>
    {{ end }}
  {{ end }}
</nav>
{{ end }}

<h2>Edit Contact</h2>

{{ if .Error }}
<div class="alert alert-red">
  <h5 class="alert-title">Error</h5>
  <p>{{.Error}}</p>
</div>
{{end}}

{{ if .Contact.CardDAVUUID }}
<div class="alert alert-grey">
  <h5 class="alert-title">CardDAV Synced Contact</h5>
  <p>This contact is synced with CardDAV. Changes to name, organization, and job title will be pushed to CardDAV.</p>
</div>
{{ end }}

<form method="POST" action="/contact/{{ .Contact.ID }}/edit">
  <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
  <div class="form-group">
    <label for="name_given" class="item-title">First Name <span class="required">*</span></label>
    <input type="text" id="name_given" name="name_given" class="form-item" required
           value="{{ with .Contact.NameGiven }}{{ . }}{{ end }}"
           placeholder="e.g., John">
    {{ if .Contact.CardDAVUUID }}
    <small class="muted-text">Changes will sync to CardDAV</small>
    {{ else }}
    <small class="muted-text">Required</small>
    {{ end }}
  </div>

  <div class="form-group">
    <label for="name_family" class="item-title">Last Name</label>
    <input type="text" id="name_family" name="name_family" class="form-item"
           value="{{ with .Contact.NameFamily }}{{ . }}{{ end }}"
           placeholder="e.g., Doe">
    {{ if .Contact.CardDAVUUID }}
    <small class="muted-text">Changes will sync to CardDAV</small>
    {{ end }}
  </div>

  <div class="form-group">
    <label for="organization" class="item-title">Organization</label>
    <input type="text" id="organization" name="organization" class="form-item"
           value="{{ with .Contact.Organization }}{{ . }}{{ end }}"
           placeholder="e.g., Acme Corp">
    {{ if .Contact.CardDAVUUID }}
    <small class="muted-text">Changes will sync to CardDAV</small>
    {{ end }}
  </div>

  <div class="form-group">
    <label for="title" class="item-title">Job Title</label>
    <input type="text" id="title" name="title" class="form-item"
           value="{{ with .Contact.Title }}{{ . }}{{ end }}"
           placeholder="e.g., Software Engineer">
    {{ if .Contact.CardDAVUUID }}
    <small class="muted-text">Changes will sync to CardDAV</small>
    {{ end }}
  </div>

  <div class="form-group">
    <label class="checkbox-label">
      <input type="checkbox" name="is_me" {{ if .Contact.IsMe }}checked{{ end }}>
      This is me
    </label>
    <small class="muted-text">Used for the vCard download shown in secure contact exchange links.</small>
    {{ if and .CurrentMeContactID (ne .CurrentMeContactID .Contact.ID.String) }}
    <small class="muted-text">
      Currently marked as me: <a href="/contact/{{ .CurrentMeContactID }}">{{ .CurrentMeContactName }}</a>.
      Saving with this checked will replace it.
    </small>
    {{ end }}
  </div>

  {{ if not .Contact.IsService }}
  <div class="form-group">
    <label for="call_sign" class="item-title">Amateur Radio Call Sign</label>
    <input type="text" id="call_sign" name="call_sign" class="form-item callsign-input"
           value="{{ with .Contact.CallSign }}{{ . }}{{ end }}"
           placeholder="e.g., W1AW"
           pattern="[A-Za-z0-9]{3,8}">
    <small class="muted-text">3-8 characters, letters and numbers only</small>
  </div>

  <div class="form-group">
    <label for="tier" class="item-title">Tier</label>
    <select id="tier" name="tier" class="form-item">
      <option value="A" {{ if eq .Contact.Tier "A" }}selected{{ end }}>A - Closest relationships (contact every 3 weeks)</option>
      <option value="B" {{ if eq .Contact.Tier "B" }}selected{{ end }}>B - Close friends (contact every 2 months)</option>
      <option value="C" {{ if eq .Contact.Tier "C" }}selected{{ end }}>C - Regular contacts (contact every 6 months)</option>
      <option value="D" {{ if eq .Contact.Tier "D" }}selected{{ end }}>D - Occasional contacts (contact every year)</option>
      <option value="E" {{ if eq .Contact.Tier "E" }}selected{{ end }}>E - Distant contacts (contact every 2 years)</option>
      <option value="F" {{ if eq .Contact.Tier "F" }}selected{{ end }}>F - No regular contact needed</option>
    </select>
    <small class="muted-text">How often you should stay in touch with this person</small>
  </div>
  {{ end }}

  <div class="form-group">
    <hr class="contact-type-divider">
    <h4 class="contact-type-heading">Contact Type</h4>
    {{ if .Contact.IsService }}
    <p class="muted-text contact-type-description">This is a service contact. Service contacts have simplified profiles without relationship tracking features.</p>
    <button type="submit" name="toggle_service" value="true" class="btn"
            onclick="document.getElementById('service_type').value='false'; return true;">
      Convert to Personal Contact
    </button>
    <input type="hidden" id="service_type" name="is_service" value="false">
    {{ else }}
    <p class="muted-text contact-type-description">This is a personal contact with full relationship tracking features.</p>
    <button type="submit" name="toggle_service" value="true" class="btn"
            onclick="if(confirm('Convert to service contact? This will hide relationship tracking features like tier, notes, and contact logs.')) { document.getElementById('service_type').value='true'; return true; } return false;">
      Convert to Service Contact
    </button>
    <input type="hidden" id="service_type" name="is_service" value="true">
    {{ end }}
  </div>

  <div class="form-group">
    <button type="submit" class="btn">Save Changes</button>
    <a href="/contact/{{ .Contact.ID }}" class="btn">Cancel</a>
  </div>
</form>

<div class="form-group">
  <hr class="contact-type-divider">
  <h4 class="contact-type-heading">CardDAV Integration</h4>
  {{ if .Contact.CardDAVUUID }}
  <p class="muted-text contact-type-description">This contact is linked to CardDAV and syncs automatically.</p>
  <form method="POST" action="/contact/{{ .Contact.ID }}/carddav/unlink" onsubmit="return confirm('Unlink this contact from CardDAV? The local contact data will remain, but will no longer sync.');">
    <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
    <button type="submit" class="btn">Unlink from CardDAV</button>
  </form>
  {{ else }}
  <p class="muted-text contact-type-description">This contact is not linked to CardDAV. You can link it to an existing CardDAV contact or migrate the data to create a new CardDAV contact.</p>
  <div class="page-header-actions">
    <button type="button" class="btn" onclick="openCardDAVLinkDialog()">Link to Existing</button>
    <form method="POST" action="/contact/{{ .Contact.ID }}/carddav/migrate" onsubmit="return confirm('Create a new CardDAV contact from this local data? This will migrate the name, emails, and phone numbers to CardDAV. Notes will remain in Groundwave only.');">
      <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
      <button type="submit" class="btn">Migrate to CardDAV</button>
    </form>
  </div>
  {{ end }}
</div>

<input type="hidden" id="csrf-token" value="{{ .csrf_token }}" />
<script>
function openCardDAVLinkDialog() {
  const width = 600;
  const height = 700;
  const left = (screen.width - width) / 2;
  const top = (screen.height - height) / 2;

  window.open(
    '/carddav/picker',
    'CardDAV Contact Picker',
    `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
  );
}

window.addEventListener('message', function(event) {
  if (event.origin !== window.location.origin) {
    return;
  }

  if (event.data.type === 'carddav-contact-selected') {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/contact/{{ .Contact.ID }}/carddav/link';

    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = '_csrf';
    csrfInput.value = document.getElementById('csrf-token').value;
    form.appendChild(csrfInput);

    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'carddav_uuid';
    input.value = event.data.uuid;

    form.appendChild(input);
    document.body.appendChild(form);
    form.submit();
  }
});
</script>

{{ template "foot" . }}
