{{ template "head" . }}

{{ if .Breadcrumbs }}
<nav class="breadcrumb" aria-label="Breadcrumb">
  {{ range $i, $b := .Breadcrumbs }}
    {{ if $i }}<span class="breadcrumb-separator">&gt;</span>{{ end }}
    {{ if $b.IsCurrent }}
      <span class="breadcrumb-current">{{ $b.Name }}</span>
    {{ else }}
      <a href="{{ $b.URL }}" class="breadcrumb-item">{{ $b.Name }}</a>
    {{ end }}
  {{ end }}
</nav>
{{ end }}

<div class="page-header">
  <h2>QSL Contacts</h2>
  <div class="page-header-actions">
    <a href="/qsl/callsigns" class="btn">Callsigns</a>
    <a href="/qsl/export" class="btn">Export ADIF</a>
    <form method="POST" action="/qsl/import/qrz" class="inline-form">
      <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
      <button type="submit" class="btn">Sync QRZ</button>
    </form>
    <form method="POST" action="/qsl/import" enctype="multipart/form-data" id="adif-import-form" class="inline-form">
      <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
      <input type="file" name="adif_file" id="adif_file" accept=".adi,.adif" class="hidden-file-input" onchange="this.form.submit()">
      <button type="button" class="btn" onclick="document.getElementById('adif_file').click()">Import ADIF</button>
    </form>
  </div>
</div>

{{ if .Error }}
<div class="alert alert-red">
  {{ .Error }}
</div>
{{ end }}

{{ if .QSLCardRequestsError }}
<div class="alert alert-yellow">
  {{ .QSLCardRequestsError }}
</div>
{{ end }}

{{ if .QSLCardRequests }}
<h3 class="section-heading">QSL Card Requests ({{ len .QSLCardRequests }})</h3>
<p class="muted-text">Submitted from public OQRS pages. Dismiss removes the card only.</p>

<div class="list-card-list">
  {{ range .QSLCardRequests }}
  <div class="list-card qsl-request-card">
    <div class="qsl-request-card-header">
      <div>
        <div><span class="qso-callsign">{{ .Call }}</span> • {{ .QSODate.Format "2006-01-02" }} {{ .TimeOn.Format "15:04" }}Z</div>
        <div class="muted-text">
          {{ .Mode }}{{ if .Band }} • {{ .Band }}{{ end }}{{ if .Country }} • {{ .Country }}{{ end }} • Requested {{ .CreatedAt.Format "2006-01-02 15:04" }}
        </div>
      </div>
      <form method="POST" action="/qsl/requests/{{ .ID }}/dismiss" class="inline-form">
        <input type="hidden" name="_csrf" value="{{ $.csrf_token }}" />
        <button type="submit" class="btn btn-small">Dismiss</button>
      </form>
    </div>

    {{ if .RequesterName }}
    <p><strong>Name:</strong> {{ .RequesterName }}</p>
    {{ end }}

    <p><strong>Mailing Address</strong></p>
    <div class="qsl-request-address">{{ .MailingAddress }}</div>

    {{ if .Note }}
    <p><strong>Note:</strong> {{ .Note }}</p>
    {{ end }}

    <p><a href="/qsl/{{ .QSOID }}">Open QSO</a></p>
  </div>
  {{ end }}
</div>
{{ end }}

{{ if .QSOs }}
<input type="text" id="qslSearch" placeholder="Search by call sign, country, mode, or band..." class="search-input">

<p class="muted-text qso-count">Total QSOs: {{ len .QSOs }}</p>

<div class="list-card-list" id="qslList">
  {{ range .QSOs }}
  <div class="list-card">
    <a href="/qsl/{{ .ID }}">
      <div><span class="qso-callsign">{{ .Call }}</span> • {{ .QSODate.Format "2006-01-02" }} {{ .TimeOn.Format "15:04" }}Z</div>
      <div class="muted-text">
        {{ .Mode }}{{ if .Band }} • {{ .Band }}{{ end }}{{ if .Country }} • {{ .Country }}{{ end }}
      </div>
      <div style="display:none;">
        {{ if .Name }}{{ .Name }} {{ end }}{{ if .QTH }}{{ .QTH }} {{ end }}{{ if .State }}{{ .State }} {{ end }}{{ if .GridSquare }}{{ .GridSquare }}{{ end }}
      </div>
    </a>
  </div>
  {{ end }}
</div>
{{ else }}
<div class="alert alert-grey">
  <h5 class="alert-title">No QSOs Yet</h5>
  <p>You haven't imported any QSOs yet. Use "Sync QRZ" or "Import ADIF" above to bring in your logbook.</p>
</div>
{{ end }}

{{ if .QSOs }}
<script>
(function() {
  const searchInput = document.getElementById('qslSearch');
  const qslList = document.getElementById('qslList');
  const entries = qslList.getElementsByClassName('list-card');

  if (searchInput && entries) {
    searchInput.addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase();

      Array.from(entries).forEach(function(entry) {
        const text = entry.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
          entry.style.display = '';
        } else {
          entry.style.display = 'none';
        }
      });
    });
  }
})();
</script>
{{ end }}

{{ template "foot" . }}
